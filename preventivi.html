  <!-- Libreria per esportare in PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const nav = document.getElementById("nav");
    const navToggle = document.getElementById("navToggle");
    if (nav && navToggle) {
      navToggle.addEventListener("click", () => {
        nav.classList.toggle("mobile-open");
      });
    }

    const commissioneInput = document.getElementById("commissionePerc");
    const freqInput = document.getElementById("freq");
    const oreIntInput = document.getElementById("oreInt");
    const kmIntInput = document.getElementById("kmInt");
    const costoOraSelect = document.getElementById("costoOra");
    const margineInput = document.getElementById("marginePerc");

    const oreMeseSpan = document.getElementById("oreMese");
    const costoLavoroSpan = document.getElementById("costoLavoro");
    const costoAutoSpan = document.getElementById("costoAuto");
    const costoProdottiSpan = document.getElementById("costoProdotti");
    const costoTotaleBaseSpan = document.getElementById("costoTotaleBase");
    const prezzoBaseSpan = document.getElementById("prezzoBase");
    const commissioneEuroSpan = document.getElementById("commissioneEuro");
    const costoTotaleSpan = document.getElementById("costoTotale");
    const prezzoMeseSpan = document.getElementById("prezzoMese");
    const tariffaOraSpan = document.getElementById("tariffaOra");
    const margineEuroSpan = document.getElementById("margineEuro");
    const margineEffSpan = document.getElementById("margineEff");

    function formatEuro(val) {
      return val.toFixed(2).replace(".", ",") + " €";
    }

    function formatOre(val) {
      return val.toFixed(2).replace(".", ",") + " h";
    }

    function formatPerc(val) {
      return val.toFixed(1).replace(".", ",") + " %";
    }

    function calcola() {
      const freq = parseFloat(freqInput.value) || 0;
      const oreInt = parseFloat(oreIntInput.value) || 0;
      const kmInt = parseFloat(kmIntInput.value) || 0;
      const costoOra = parseFloat(costoOraSelect.value) || 0;
      const marginePerc = parseFloat(margineInput.value) || 0;
      const commissionePerc = parseFloat(commissioneInput.value) || 0;

      const oreMese = freq * oreInt * 4.33;
      const costoLavoro = oreMese * costoOra;
      const costoAuto = kmInt * 0.30 * freq * 4.33;

      const baseCost = costoLavoro + costoAuto;
      const costoProdotti = baseCost * 0.07;
      const costoTotaleBase = baseCost + costoProdotti;

      const margineFactor = 1 + (marginePerc > 0 ? marginePerc / 100 : 0);
      const prezzoBase = costoTotaleBase * margineFactor;

      const commissioneEuro = commissionePerc > 0 ? prezzoBase * (commissionePerc / 100) : 0;
      const costoTotale = costoTotaleBase + commissioneEuro;

      const prezzoMese = prezzoBase + commissioneEuro;

      const tariffaOra = oreMese > 0 ? prezzoMese / oreMese : 0;
      const margineEuro = prezzoMese - costoTotale;
      const margineEff = prezzoMese > 0 ? (margineEuro / prezzoMese) * 100 : 0;

      oreMeseSpan.textContent = formatOre(oreMese);
      costoLavoroSpan.textContent = formatEuro(costoLavoro);
      costoAutoSpan.textContent = formatEuro(costoAuto);
      costoProdottiSpan.textContent = formatEuro(costoProdotti);
      costoTotaleBaseSpan.textContent = formatEuro(costoTotaleBase);
      prezzoBaseSpan.textContent = formatEuro(prezzoBase);
      commissioneEuroSpan.textContent = formatEuro(commissioneEuro);
      costoTotaleSpan.textContent = formatEuro(costoTotale);
      prezzoMeseSpan.textContent = formatEuro(prezzoMese);
      tariffaOraSpan.textContent = tariffaOra.toFixed(2).replace(".", ",") + " €/h";
      margineEuroSpan.textContent = formatEuro(margineEuro);
      margineEffSpan.textContent = formatPerc(margineEff);
    }

    document.getElementById("calcolaBtn").addEventListener("click", calcola);

    document.getElementById("resetBtn").addEventListener("click", () => {
      commissioneInput.value = "";
      freqInput.value = 2;
      oreIntInput.value = 2;
      kmIntInput.value = 0;
      costoOraSelect.value = "14";
      margineInput.value = "";
      calcola();
    });

    [commissioneInput, freqInput, oreIntInput, kmIntInput, costoOraSelect, margineInput].forEach(el => {
      el.addEventListener("input", calcola);
    });

    // Primo calcolo iniziale
    calcola();

    // PDF export: usiamo tutto il blocco dello strumento
    const pdfBtn = document.getElementById("pdfBtn");
    const pdfSource = document.querySelector(".tool-box");

    if (pdfBtn && pdfSource) {
      pdfBtn.addEventListener("click", () => {
        const opt = {
          margin:       10,
          filename:     'preventivo-ea-cleaning.pdf',
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2 },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // clono il blocco per non rovinare il layout della pagina
        const clone = pdfSource.cloneNode(true);
        clone.style.background = "#ffffff";
        clone.style.color = "#000000";

        const wrapper = document.createElement("div");
        wrapper.appendChild(clone);

        html2pdf().from(wrapper).set(opt).save();
      });
    }
  </script>

