<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Area preventivi – EA Cleaning</title>

  <!-- Manifest / icone PWA opzionali -->
  <meta name="theme-color" content="#0b5fa5" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="/assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/assets/icons/icon-512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <link rel="stylesheet" href="style.css" />

  <style>
    main {
      padding: 2.1rem 0 3rem;
    }

    .ea-main-container {
      max-width: 980px;
      margin: 0 auto;
    }

    .ea-logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .ea-logo-wrap img {
      max-width: 220px;
      height: auto;
    }

    .ea-title-wrap {
      text-align: center;
      margin-bottom: 1.2rem;
    }

    .ea-title-wrap h1 {
      font-size: 1.9rem;
      letter-spacing: 0.02em;
      margin-bottom: 0.3rem;
    }

    .ea-title-wrap p {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .panel {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid var(--border-subtle, #e5e7eb);
      padding: 1.25rem 1.25rem 1.4rem;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.04);
      margin-bottom: 1.2rem;
    }

    .panel-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 0.9rem;
      color: #0f172a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-title span {
      font-size: 0.8rem;
      font-weight: 500;
      color: #6b7280;
    }

    .two-cols {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.9rem;
    }

    @media (max-width: 800px) {
      .two-cols {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      margin-bottom: 0.7rem;
    }

    .field-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: #111827;
      margin-bottom: 0.2rem;
    }

    .field-input,
    .field-textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.65rem;
      font-size: 0.9rem;
      outline: none;
      background: #ffffff;
    }

    .field-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .field-input:focus,
    .field-textarea:focus {
      border-color: #0b5fa5;
      box-shadow: 0 0 0 1px rgba(11, 95, 165, 0.18);
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .field-suffix {
      font-size: 0.8rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .field-checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      margin-top: 0.3rem;
    }

    .field-checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .field-checkbox-row label {
      font-size: 0.86rem;
      color: #111827;
    }

    .field-help {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 0.15rem;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    .btn-main,
    .btn-outline,
    .btn-ghost,
    .btn-mini {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 0.58rem 1.3rem;
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .btn-main {
      background: #0b5fa5;
      color: #ffffff;
    }

    .btn-outline {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    .btn-ghost {
      background: #ffffff;
      color: #111827;
      border: 1px dashed #d1d5db;
    }

    .btn-mini {
      padding: 0.35rem 0.7rem;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.3rem;
      font-size: 0.88rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      gap: 0.7rem;
    }

    .summary-label {
      color: #6b7280;
    }

    .summary-value {
      font-weight: 600;
    }

    .summary-value.cost {
      color: #b91c1c;
    }

    .summary-value.rev {
      color: #15803d;
    }

    .summary-footer {
      margin-top: 0.9rem;
      border-radius: 16px;
      padding: 0.75rem 1rem;
      background: linear-gradient(90deg, #0b5fa5, #16a34a);
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 0.98rem;
    }

    .summary-footer span:last-child {
      font-size: 1.05rem;
    }

    .storico-panel {
      margin-top: 1.2rem;
    }

    .storico-list {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      font-size: 0.85rem;
    }

    .storico-item {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 0.6rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      background: #f9fafb;
    }

    .storico-main {
      display: flex;
      justify-content: space-between;
      gap: 0.6rem;
      align-items: baseline;
    }

    .storico-title {
      font-weight: 600;
      color: #0f172a;
      font-size: 0.9rem;
    }

    .storico-sub {
      font-size: 0.78rem;
      color: #6b7280;
    }

    .storico-importo {
      font-weight: 600;
      color: #15803d;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .storico-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- HEADER SITO PRINCIPALE -->
    <header>
      <div class="container">
        <nav class="nav" id="nav">
          <div class="brand">
            <div class="brand-avatar">
              <img src="assets/img/Emir%20primo%20piano.jpg" alt="Emir Alili" />
            </div>
            <div class="brand-text">
              <strong>Emir Alili</strong>
              <span>Imprenditore, autore, leader politico</span>
            </div>
          </div>

          <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="chi-sono.html">Chi sono</a>
            <a href="cosa-faccio.html">Cosa faccio</a>
            <a href="contatti.html">Contatti</a>
          </div>

          <div class="nav-cta">
            <button class="btn-header" type="button" onclick="window.location.href='contatti.html'">
              Contatti
            </button>
          </div>

          <button class="nav-toggle" type="button" aria-label="Menu" id="navToggle">☰</button>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="ea-main-container">

          <!-- LOGO + TITOLO -->
          <div class="ea-logo-wrap">
            <img src="assets/logos/Logo%20EA%20Cleaning.png" alt="EA Cleaning Services" />
          </div>
          <div class="ea-title-wrap">
            <h1>Area preventivi</h1>
            <p>Strumento interno per calcolo, approvazione e archivio.</p>
          </div>

          <!-- DATI CLIENTE -->
          <section class="panel">
            <div class="panel-title">
              Dati cliente
              <span>Numero e data vengono precompilati in automatico.</span>
            </div>

            <div class="two-cols">
              <div>
                <div class="field">
                  <label class="field-label" for="numPreventivo">Numero preventivo</label>
                  <input class="field-input" id="numPreventivo" type="text" />
                </div>

                <div class="field">
                  <label class="field-label" for="dataPreventivo">Data preventivo</label>
                  <input class="field-input" id="dataPreventivo" type="date" />
                </div>

                <div class="field">
                  <label class="field-label" for="clienteRagione">Ragione sociale / Cliente</label>
                  <input class="field-input" id="clienteRagione" type="text" />
                </div>

                <div class="field">
                  <label class="field-label" for="clienteIndirizzo">Indirizzo</label>
                  <input class="field-input" id="clienteIndirizzo" type="text" />
                </div>
              </div>

              <div>
                <div class="field">
                  <label class="field-label" for="clienteTelefono">Telefono</label>
                  <input class="field-input" id="clienteTelefono" type="text" />
                </div>

                <div class="field">
                  <label class="field-label" for="clienteEmail">Email</label>
                  <input class="field-input" id="clienteEmail" type="email" />
                </div>

                <div class="field">
                  <label class="field-label" for="oggettoPreventivo">Oggetto preventivo</label>
                  <input class="field-input" id="oggettoPreventivo" type="text" />
                </div>

                <div class="field">
                  <label class="field-label" for="descrizionePreventivo">Descrizione</label>
                  <textarea class="field-textarea" id="descrizionePreventivo"></textarea>
                </div>
              </div>
            </div>
          </section>

          <!-- PARAMETRI DI LAVORO -->
          <section class="panel">
            <div class="panel-title">
              Parametri di lavoro
              <span>Base di calcolo: 23 €/h interno · 26 €/h subappalto.</span>
            </div>

            <div class="two-cols">
              <div>
                <div class="field">
                  <label class="field-label" for="interventiSett">Interventi settimanali</label>
                  <div class="field-row">
                    <input class="field-input" id="interventiSett" type="number" step="0.5" value="2" />
                    <span class="field-suffix">n° / settimana</span>
                  </div>
                </div>

                <div class="field">
                  <label class="field-label" for="oreIntervento">Ore per intervento</label>
                  <div class="field-row">
                    <input class="field-input" id="oreIntervento" type="number" step="0.25" value="2" />
                    <span class="field-suffix">ore</span>
                  </div>
                </div>

                <div class="field">
                  <div class="field-checkbox-row">
                    <input type="checkbox" id="flagProvvigione" />
                    <label for="flagProvvigione">Provvigione agente / intermediario</label>
                  </div>
                  <div class="field-row" style="margin-top:0.25rem;">
                    <input class="field-input" id="provvigionePerc" type="number" step="0.5" value="0" disabled />
                    <span class="field-suffix">% sul prezzo finale</span>
                  </div>
                </div>

                <div class="field">
                  <div class="field-checkbox-row">
                    <input type="checkbox" id="flagSubappalto" />
                    <label for="flagSubappalto">Subappalto (costo 16 €/h, prezzo base 26 €/h)</label>
                  </div>
                </div>
              </div>

              <div>
                <div class="field">
                  <div class="field-checkbox-row">
                    <input type="checkbox" id="flagCostoPersonalizzato" />
                    <label for="flagCostoPersonalizzato">Costo orario interno</label>
                  </div>
                  <div class="field-row" style="margin-top:0.25rem;">
                    <input class="field-input" id="costoOrarioInterno" type="number" step="0.5" value="23" disabled />
                    <span class="field-suffix">€/h</span>
                  </div>
                </div>

                <div class="field">
                  <span class="field-label">Costo prodotti</span>
                  <span class="field-help">10% automatico sul costo lavoro.</span>
                </div>

                <div class="field">
                  <div class="field-checkbox-row">
                    <input type="checkbox" id="flagAttrezzature" />
                    <label for="flagAttrezzature">Attrezzature / noleggi</label>
                  </div>
                  <div class="field-row" style="margin-top:0.25rem;">
                    <input class="field-input" id="costoAttrezzature" type="number" step="1" value="0" disabled />
                    <span class="field-suffix">€/mese</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn-main" type="button" id="calcolaBtn">Calcola preventivo</button>
              <button class="btn-outline" type="button" id="pdfInternoBtn">Esporta PDF (interno)</button>
              <button class="btn-outline" type="button" id="pdfClienteBtn">PDF cliente</button>
              <button class="btn-ghost" type="button" id="approvaBtn">Approva (salva storico)</button>
              <button class="btn-outline" type="button" id="resetBtn">Reset</button>
            </div>
          </section>

          <!-- RIEPILOGO -->
          <section class="panel">
            <div class="panel-title">Riepilogo economico mensile</div>

            <div class="summary-grid">
              <div class="summary-row">
                <span class="summary-label">Ore totali mese</span>
                <span class="summary-value" id="oreMese">0,00 h</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Costo lavoro</span>
                <span class="summary-value cost" id="costoLavoro">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Costo prodotti (10%)</span>
                <span class="summary-value cost" id="costoProdotti">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Costo attrezzature</span>
                <span class="summary-value cost" id="costoAttrezzatureRes">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Provvigione</span>
                <span class="summary-value cost" id="costoProvvigione">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Costi accessori totali</span>
                <span class="summary-value cost" id="costoTotale">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Tariffa oraria effettiva cliente</span>
                <span class="summary-value rev" id="prezzoOrarioRes">0,00 €/h</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Ricavo lavoro (solo ore)</span>
                <span class="summary-value rev" id="ricavoLavoro">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Guadagno netto</span>
                <span class="summary-value rev" id="guadagnoNetto">0,00 €</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Guadagno netto %</span>
                <span class="summary-value rev" id="guadagnoPerc">0,0 %</span>
              </div>
            </div>

            <div class="summary-footer">
              <span>Totale mensile da proporre al cliente</span>
              <span id="prezzoTotaleCliente">0,00 €</span>
            </div>
          </section>

          <!-- STORICO -->
          <section class="panel storico-panel">
            <div class="panel-title">
              Preventivi storici
              <span>Vengono salvati solo quando clicchi “Approva”.</span>
            </div>
            <div class="storico-list" id="storicoList"></div>
          </section>

        </div>
      </div>
    </main>

    <!-- FOOTER SITO PRINCIPALE -->
    <footer>
      <div class="container">
        <div class="footer-inner">
          <div class="footer-links">
            <span>© <span id="year"></span> Emir Alili.</span>
            <span>Strumento interno preventivi EA Cleaning.</span>
          </div>
          <div class="footer-social">
            <a href="mailto:info@emiralili.it">Email</a>
            <a href="https://www.facebook.com/emir.alili.81/" target="_blank" rel="noopener noreferrer">Facebook</a>
            <a href="https://www.linkedin.com/in/emiralili/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const nav = document.getElementById("nav");
    const navToggle = document.getElementById("navToggle");
    if (nav && navToggle) {
      navToggle.addEventListener("click", function () {
        nav.classList.toggle("mobile-open");
      });
    }

    // ========= UTILITA' FORMATO =========
    function formatEuro(val) {
      return val.toFixed(2).replace(".", ",") + " €";
    }

    function formatOre(val) {
      return val.toFixed(2).replace(".", ",") + " h";
    }

    function formatPerc(val) {
      return val.toFixed(1).replace(".", ",") + " %";
    }

    // ========= CAMPI =========

    // Dati cliente
    const numPreventivoInput = document.getElementById("numPreventivo");
    const dataPreventivoInput = document.getElementById("dataPreventivo");
    const clienteRagioneInput = document.getElementById("clienteRagione");
    const clienteIndirizzoInput = document.getElementById("clienteIndirizzo");
    const clienteTelefonoInput = document.getElementById("clienteTelefono");
    const clienteEmailInput = document.getElementById("clienteEmail");
    const oggettoPreventivoInput = document.getElementById("oggettoPreventivo");
    const descrizionePreventivoInput = document.getElementById("descrizionePreventivo");

    // Parametri lavoro
    const interventiInput = document.getElementById("interventiSett");
    const oreInterventoInput = document.getElementById("oreIntervento");

    const flagProvvigione = document.getElementById("flagProvvigione");
    const provvigionePercInput = document.getElementById("provvigionePerc");

    const flagSubappalto = document.getElementById("flagSubappalto");
    const flagCostoPersonalizzato = document.getElementById("flagCostoPersonalizzato");
    const costoOrarioInternoInput = document.getElementById("costoOrarioInterno");

    const flagAttrezzature = document.getElementById("flagAttrezzature");
    const costoAttrezzatureInput = document.getElementById("costoAttrezzature");

    // Bottoni
    const calcolaBtn = document.getElementById("calcolaBtn");
    const pdfInternoBtn = document.getElementById("pdfInternoBtn");
    const pdfClienteBtn = document.getElementById("pdfClienteBtn");
    const approvaBtn = document.getElementById("approvaBtn");
    const resetBtn = document.getElementById("resetBtn");

    // Riepilogo
    const oreMeseSpan = document.getElementById("oreMese");
    const costoLavoroSpan = document.getElementById("costoLavoro");
    const costoProdottiSpan = document.getElementById("costoProdotti");
    const costoAttrezzatureResSpan = document.getElementById("costoAttrezzatureRes");
    const costoProvvigioneSpan = document.getElementById("costoProvvigione");
    const costoTotaleSpan = document.getElementById("costoTotale");
    const prezzoOrarioResSpan = document.getElementById("prezzoOrarioRes");
    const ricavoLavoroSpan = document.getElementById("ricavoLavoro");
    const guadagnoNettoSpan = document.getElementById("guadagnoNetto");
    const guadagnoPercSpan = document.getElementById("guadagnoPerc");
    const prezzoTotaleClienteSpan = document.getElementById("prezzoTotaleCliente");

    const storicoListEl = document.getElementById("storicoList");

    // Per conservare l'ultimo calcolo
    let lastCalcolo = {
      oreMese: 0,
      prezzoLavoro: 0,
      costoProdotti: 0,
      costoAttrezzature: 0,
      provvigioneEuro: 0,
      costoAccessori: 0,
      prezzoCliente: 0,
      prezzoOrario: 0,
      guadagnoNetto: 0,
      guadagnoPerc: 0
    };

    // ========= NUMERO E DATA PREVENTIVO =========

    const NUM_KEY = "eaLastPreventivoNumber_v2";

    function getTodayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function getNextNumeroPreventivo() {
      const year = new Date().getFullYear();
      const raw = localStorage.getItem(NUM_KEY);
      if (!raw || raw.indexOf(year + "-") !== 0) {
        const val = year + "-001";
        localStorage.setItem(NUM_KEY, val);
        return val;
      }
      const parts = raw.split("-");
      let seq = parseInt(parts[1], 10) || 0;
      seq++;
      let seqStr = String(seq);
      while (seqStr.length < 3) seqStr = "0" + seqStr;
      const next = parts[0] + "-" + seqStr;
      localStorage.setItem(NUM_KEY, next);
      return next;
    }

    function initNumeroData() {
      if (!numPreventivoInput.value) {
        numPreventivoInput.value = getNextNumeroPreventivo();
      }
      if (!dataPreventivoInput.value) {
        dataPreventivoInput.value = getTodayISO();
      }
    }

    // ========= ABILITAZIONE CAMPI FLAG =========

    flagProvvigione.addEventListener("change", () => {
      provvigionePercInput.disabled = !flagProvvigione.checked;
      if (!flagProvvigione.checked) provvigionePercInput.value = "0";
      calcola();
    });

    flagCostoPersonalizzato.addEventListener("change", () => {
      costoOrarioInternoInput.disabled = !flagCostoPersonalizzato.checked;
      if (!flagCostoPersonalizzato.checked) costoOrarioInternoInput.value = "23";
      calcola();
    });

    flagAttrezzature.addEventListener("change", () => {
      costoAttrezzatureInput.disabled = !flagAttrezzature.checked;
      if (!flagAttrezzature.checked) costoAttrezzatureInput.value = "0";
      calcola();
    });

    flagSubappalto.addEventListener("change", () => {
      calcola();
    });

    // ========= CALCOLO =========

    function calcola() {
      const freq = parseFloat(interventiInput.value) || 0;
      const oreInt = parseFloat(oreInterventoInput.value) || 0;

      const oreMese = freq * oreInt * 4.33;

      const provvigioneAttiva = flagProvvigione.checked;
      const provPerc = provvigioneAttiva ? (parseFloat(provvigionePercInput.value) || 0) : 0;

      const subappaltoAttivo = flagSubappalto.checked;
      const costoPersonalizzatoAttivo = flagCostoPersonalizzato.checked;

      const attrezzatureAttive = flagAttrezzature.checked;
      const costoAttrezzature = attrezzatureAttive
        ? (parseFloat(costoAttrezzatureInput.value) || 0)
        : 0;

      // Prezzo orario di riferimento
      let prezzoOrarioRif;
      if (subappaltoAttivo) {
        prezzoOrarioRif = 26; // 16 costo esterno + 10 margine minimo
      } else {
        prezzoOrarioRif = costoPersonalizzatoAttivo
          ? (parseFloat(costoOrarioInternoInput.value) || 23)
          : 23;
      }

      const prezzoLavoro = oreMese * prezzoOrarioRif;
      const costoProdotti = prezzoLavoro * 0.10;
      const costoAttrezzatureCalcolato = costoAttrezzature;

      const baseSenzaProvvigione = prezzoLavoro + costoProdotti + costoAttrezzatureCalcolato;

      let provvigioneEuro = 0;
      let prezzoCliente = baseSenzaProvvigione;

      if (provPerc > 0) {
        // Prezzo finale tale che la provvigione sia un costo in più
        prezzoCliente = baseSenzaProvvigione / (1 - provPerc / 100);
        provvigioneEuro = prezzoCliente - baseSenzaProvvigione;
      }

      const costoAccessori = costoProdotti + costoAttrezzatureCalcolato + provvigioneEuro;

      const prezzoOrarioEffettivo = oreMese > 0 ? prezzoCliente / oreMese : 0;

      const guadagnoNetto = prezzoCliente - costoAccessori; // di fatto = lavoro
      const guadagnoPerc = prezzoCliente > 0 ? (guadagnoNetto / prezzoCliente) * 100 : 0;

      lastCalcolo = {
        oreMese,
        prezzoLavoro,
        costoProdotti,
        costoAttrezzature: costoAttrezzatureCalcolato,
        provvigioneEuro,
        costoAccessori,
        prezzoCliente,
        prezzoOrario: prezzoOrarioEffettivo,
        guadagnoNetto,
        guadagnoPerc
      };

      // Aggiorna UI
      oreMeseSpan.textContent = formatOre(oreMese);
      costoLavoroSpan.textContent = formatEuro(prezzoLavoro);
      costoProdottiSpan.textContent = formatEuro(costoProdotti);
      costoAttrezzatureResSpan.textContent = formatEuro(costoAttrezzatureCalcolato);
      costoProvvigioneSpan.textContent = formatEuro(provvigioneEuro);
      costoTotaleSpan.textContent = formatEuro(costoAccessori);

      prezzoOrarioResSpan.textContent =
        prezzoOrarioEffettivo.toFixed(2).replace(".", ",") + " €/h";

      ricavoLavoroSpan.textContent = formatEuro(prezzoLavoro);
      guadagnoNettoSpan.textContent = formatEuro(guadagnoNetto);
      guadagnoPercSpan.textContent = formatPerc(guadagnoPerc);

      prezzoTotaleClienteSpan.textContent = formatEuro(prezzoCliente);
    }

    // ========= RESET =========

    function resetForm() {
      interventiInput.value = 2;
      oreInterventoInput.value = 2;

      flagProvvigione.checked = false;
      provvigionePercInput.value = "0";
      provvigionePercInput.disabled = true;

      flagSubappalto.checked = false;

      flagCostoPersonalizzato.checked = false;
      costoOrarioInternoInput.disabled = true;
      costoOrarioInternoInput.value = "23";

      flagAttrezzature.checked = false;
      costoAttrezzatureInput.disabled = true;
      costoAttrezzatureInput.value = "0";

      calcola();
    }

    resetBtn.addEventListener("click", resetForm);
    calcolaBtn.addEventListener("click", calcola);

    // ========= STORICO =========

    const STORAGE_KEY = "eaPreventiviStorico_v2";

    function loadStorico() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveStorico(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function renderStorico() {
      const lista = loadStorico();
      storicoListEl.innerHTML = "";
      if (!lista.length) {
        const p = document.createElement("p");
        p.style.fontSize = "0.8rem";
        p.style.color = "#6b7280";
        p.textContent = "Nessun preventivo approvato al momento.";
        storicoListEl.appendChild(p);
        return;
      }

      lista.forEach(item => {
        const riga = document.createElement("div");
        riga.className = "storico-item";

        const top = document.createElement("div");
        top.className = "storico-main";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.className = "storico-title";
        title.textContent = (item.numero || "") + " – " + (item.cliente || "Senza nome");
        const sub = document.createElement("div");
        sub.className = "storico-sub";
        sub.textContent =
          (item.data || "") + (item.oggetto ? " · " + item.oggetto : "");
        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        right.className = "storico-importo";
        right.textContent = formatEuro(item.totaleCliente || 0);

        top.appendChild(left);
        top.appendChild(right);

        const actions = document.createElement("div");
        actions.className = "storico-actions";

        const btnApri = document.createElement("button");
        btnApri.className = "btn-mini";
        btnApri.textContent = "Apri";
        btnApri.addEventListener("click", () => apriPreventivo(item.id));

        const btnPdfInt = document.createElement("button");
        btnPdfInt.className = "btn-mini";
        btnPdfInt.textContent = "PDF interno";
        btnPdfInt.addEventListener("click", () => {
          apriPreventivo(item.id);
          creaPdfInterno();
        });

        const btnPdfCli = document.createElement("button");
        btnPdfCli.className = "btn-mini";
        btnPdfCli.textContent = "PDF cliente";
        btnPdfCli.addEventListener("click", () => {
          apriPreventivo(item.id);
          creaPdfCliente();
        });

        const btnDel = document.createElement("button");
        btnDel.className = "btn-mini";
        btnDel.textContent = "Elimina";
        btnDel.addEventListener("click", () => eliminaPreventivo(item.id));

        actions.appendChild(btnApri);
        actions.appendChild(btnPdfInt);
        actions.appendChild(btnPdfCli);
        actions.appendChild(btnDel);

        riga.appendChild(top);
        riga.appendChild(actions);

        storicoListEl.appendChild(riga);
      });
    }

    function raccogliDatiForm() {
      return {
        numero: numPreventivoInput.value || "",
        data: dataPreventivoInput.value || "",
        cliente: clienteRagioneInput.value || "",
        indirizzo: clienteIndirizzoInput.value || "",
        telefono: clienteTelefonoInput.value || "",
        email: clienteEmailInput.value || "",
        oggetto: oggettoPreventivoInput.value || "",
        descrizione: descrizionePreventivoInput.value || "",
        interventiSett: interventiInput.value || "",
        oreIntervento: oreInterventoInput.value || "",
        provvigioneAttiva: flagProvvigione.checked,
        provvigionePerc: provvigionePercInput.value || "",
        subappaltoAttivo: flagSubappalto.checked,
        costoPersAttivo: flagCostoPersonalizzato.checked,
        costoOrarioInterno: costoOrarioInternoInput.value || "",
        attrezzatureAttive: flagAttrezzature.checked,
        costoAttrezzature: costoAttrezzatureInput.value || ""
      };
    }

    function applicaDatiForm(d) {
      numPreventivoInput.value = d.numero || "";
      dataPreventivoInput.value = d.data || "";
      clienteRagioneInput.value = d.cliente || "";
      clienteIndirizzoInput.value = d.indirizzo || "";
      clienteTelefonoInput.value = d.telefono || "";
      clienteEmailInput.value = d.email || "";
      oggettoPreventivoInput.value = d.oggetto || "";
      descrizionePreventivoInput.value = d.descrizione || "";

      interventiInput.value = d.interventiSett || "2";
      oreInterventoInput.value = d.oreIntervento || "2";

      flagProvvigione.checked = !!d.provvigioneAttiva;
      provvigionePercInput.disabled = !flagProvvigione.checked;
      provvigionePercInput.value = d.provvigionePerc || "0";

      flagSubappalto.checked = !!d.subappaltoAttivo;

      flagCostoPersonalizzato.checked = !!d.costoPersAttivo;
      costoOrarioInternoInput.disabled = !flagCostoPersonalizzato.checked;
      costoOrarioInternoInput.value = d.costoOrarioInterno || "23";

      flagAttrezzature.checked = !!d.attrezzatureAttive;
      costoAttrezzatureInput.disabled = !flagAttrezzature.checked;
      costoAttrezzatureInput.value = d.costoAttrezzature || "0";

      calcola();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function apriPreventivo(id) {
      const lista = loadStorico();
      const found = lista.find(x => x.id === id);
      if (!found) return;
      applicaDatiForm(found.datiForm || {});
    }

    function eliminaPreventivo(id) {
      const lista = loadStorico();
      const nuova = lista.filter(x => x.id !== id);
      saveStorico(nuova);
      renderStorico();
    }

    approvaBtn.addEventListener("click", () => {
      calcola();
      const lista = loadStorico();

      const id = Date.now().toString();
      const datiForm = raccogliDatiForm();

      const elemento = {
        id,
        numero: datiForm.numero,
        data: datiForm.data,
        cliente: datiForm.cliente,
        oggetto: datiForm.oggetto,
        totaleCliente: lastCalcolo.prezzoCliente,
        datiForm
      };

      // se esiste già un preventivo con stesso numero, lo sostituisco
      const existingIndex = lista.findIndex(x => x.numero === elemento.numero);
      if (existingIndex >= 0) {
        lista[existingIndex] = elemento;
      } else {
        lista.push(elemento);
      }

      saveStorico(lista);
      renderStorico();
    });

    // ========= PDF =========

    function creaPdfInterno() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      let y = 18;
      const left = 15;
      const right = 195;

      doc.setFontSize(14);
      doc.text("EA Cleaning – Preventivo interno", left, y);
      y += 8;

      doc.setFontSize(10);
      doc.text("Nr: " + (numPreventivoInput.value || ""), left, y);
      doc.text("Data: " + (dataPreventivoInput.value || ""), left + 70, y);
      y += 6;
      doc.text("Cliente: " + (clienteRagioneInput.value || ""), left, y);
      y += 5;
      if (clienteIndirizzoInput.value) {
        doc.text("Indirizzo: " + clienteIndirizzoInput.value, left, y);
        y += 5;
      }
      if (oggettoPreventivoInput.value) {
        doc.text("Oggetto: " + oggettoPreventivoInput.value, left, y);
        y += 6;
      }

      if (descrizionePreventivoInput.value) {
        const desc = doc.splitTextToSize("Descrizione: " + descrizionePreventivoInput.value, 180);
        doc.text(desc, left, y);
        y += desc.length * 5 + 4;
      }

      doc.setFontSize(11);
      doc.text("Riepilogo economico mensile (interno)", left, y);
      y += 4;

      doc.setLineWidth(0.2);
      doc.line(left, y, right, y);
      y += 5;

      function row(label, value, type) {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        if (type === "cost") {
          doc.setTextColor(185, 28, 28);
        } else if (type === "rev") {
          doc.setTextColor(22, 163, 74);
        } else {
          doc.setTextColor(55, 65, 81);
        }
        doc.setFontSize(9);
        doc.text(label, left, y);
        doc.text(value, right, y, { align: "right" });
        y += 4.5;
      }

      row("Ore totali mese", oreMeseSpan.textContent || "0,00 h", "neutral");
      row("Costo lavoro", costoLavoroSpan.textContent || "0,00 €", "cost");
      row("Costo prodotti (10%)", costoProdottiSpan.textContent || "0,00 €", "cost");
      row("Costo attrezzature", costoAttrezzatureResSpan.textContent || "0,00 €", "cost");
      row("Provvigione", costoProvvigioneSpan.textContent || "0,00 €", "cost");
      row("Costi accessori totali", costoTotaleSpan.textContent || "0,00 €", "cost");
      row("Tariffa oraria effettiva cliente", prezzoOrarioResSpan.textContent || "0,00 €/h", "rev");
      row("Ricavo lavoro (solo ore)", ricavoLavoroSpan.textContent || "0,00 €", "rev");
      row("Guadagno netto", guadagnoNettoSpan.textContent || "0,00 €", "rev");
      row("Guadagno netto %", guadagnoPercSpan.textContent || "0,0 %", "rev");

      y += 6;
      doc.setFillColor(11, 95, 165);
      doc.setTextColor(255, 255, 255);
      doc.roundedRect(left, y - 6, 180, 10, 2, 2, "F");
      doc.setFontSize(11);
      doc.text("Totale mensile da proporre al cliente", left + 2, y);
      doc.text(prezzoTotaleClienteSpan.textContent || "0,00 €", right - 2, y, { align: "right" });

      const fileName = (numPreventivoInput.value || "preventivo-interno") + "_interno.pdf";
      doc.save(fileName);
    }

    function creaPdfCliente() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      let y = 20;
      const left = 20;
      const right = 190;

      doc.setFontSize(16);
      doc.text("EA Cleaning – Preventivo servizi di pulizia", left, y);
      y += 10;

      doc.setFontSize(11);
      doc.text("Nr: " + (numPreventivoInput.value || ""), left, y);
      doc.text("Data: " + (dataPreventivoInput.value || ""), left + 70, y);
      y += 7;

      doc.text("Cliente: " + (clienteRagioneInput.value || ""), left, y);
      y += 5;
      if (clienteIndirizzoInput.value) {
        doc.text("Indirizzo: " + clienteIndirizzoInput.value, left, y);
        y += 5;
      }
      if (clienteTelefonoInput.value) {
        doc.text("Telefono: " + clienteTelefonoInput.value, left, y);
        y += 5;
      }
      if (clienteEmailInput.value) {
        doc.text("Email: " + clienteEmailInput.value, left, y);
        y += 7;
      }

      if (oggettoPreventivoInput.value) {
        doc.setFontSize(12);
        doc.text("Oggetto: " + oggettoPreventivoInput.value, left, y);
        y += 7;
      }

      doc.setFontSize(11);
      if (descrizionePreventivoInput.value) {
        const desc = doc.splitTextToSize(descrizionePreventivoInput.value, right - left);
        doc.text(desc, left, y);
        y += desc.length * 5 + 6;
      }

      if (y > 240) {
        doc.addPage();
        y = 30;
      }

      doc.setFillColor(11, 95, 165);
      doc.setTextColor(255, 255, 255);
      doc.roundedRect(left, y - 6, right - left, 14, 2, 2, "F");
      doc.setFontSize(12);
      doc.text("Totale mensile proposto al cliente", left + 3, y);
      doc.text(prezzoTotaleClienteSpan.textContent || "0,00 €", right - 3, y, { align: "right" });

      const fileName = (numPreventivoInput.value || "preventivo-ea-cleaning") + "_cliente.pdf";
      doc.save(fileName);
    }

    pdfInternoBtn.addEventListener("click", () => {
      calcola();
      creaPdfInterno();
    });

    pdfClienteBtn.addEventListener("click", () => {
      calcola();
      creaPdfCliente();
    });

    // ========= INIT =========
    initNumeroData();
    calcola();
    renderStorico();
  </script>
</body>
</html>
