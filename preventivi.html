<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Area preventivi – Emir Alili</title>

  <!-- PWA / icone -->
  <meta name="theme-color" content="#0b4f79" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="/assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/assets/icons/icon-512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Stili globali del sito -->
  <link rel="stylesheet" href="style.css" />

  <style>
    main {
      padding: 2.1rem 0 3rem;
    }

    /* Logo EA Cleaning centrato */
    .logo-preventivi {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 1.5rem 0 0.5rem;
    }

    .logo-preventivi img {
      max-width: 220px;
      height: auto;
      display: block;
    }

    /* Piccoli aggiustamenti specifici di pagina, coerenti col resto del sito */
    .page-title-center {
      text-align: center;
      margin-bottom: 0.4rem;
      font-size: 1.8rem;
    }

    .page-subtitle-center {
      text-align: center;
      font-size: 0.95rem;
      color: #6b7280;
      margin-bottom: 1.5rem;
    }

    .panel {
      background: #ffffff;
      border-radius: 22px;
      padding: 1.4rem 1.4rem 1.5rem;
      box-shadow: 0 22px 45px rgba(15, 23, 42, 0.06);
      margin-bottom: 1.3rem;
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: #111827;
    }

    .panel-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.9rem 1rem;
    }

    @media (max-width: 720px) {
      .panel-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .field-label {
      font-size: 0.86rem;
      font-weight: 500;
      color: #111827;
    }

    .field-sublabel {
      font-size: 0.78rem;
      color: #6b7280;
    }

    .field-input,
    .field-textarea {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      outline: none;
      background: #f9fafb;
    }

    .field-textarea {
      border-radius: 18px;
      min-height: 80px;
      resize: vertical;
    }

    .field-input:focus,
    .field-textarea:focus {
      border-color: #0b4f79;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(11, 79, 121, 0.15);
    }

    .field-inline {
      display: flex;
      align-items: center;
      gap: 0.55rem;
    }

    .field-inline span.suffix {
      font-size: 0.8rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .field-checkbox {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.88rem;
    }

    .field-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .panel-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 1.1rem;
    }

    .btn-primary {
      border-radius: 999px;
      padding: 0.55rem 1.5rem;
      border: none;
      background: #005f9f;
      color: #ffffff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #004676;
    }

    .btn-outline {
      border-radius: 999px;
      padding: 0.55rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    .btn-outline:hover {
      background: #f3f4f6;
    }

    .btn-dashed {
      border-radius: 999px;
      padding: 0.55rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px dashed #9ca3af;
      background: #ffffff;
      cursor: pointer;
    }

    .btn-dashed:hover {
      background: #f9fafb;
    }

    .btn-xs {
      font-size: 0.78rem;
      border-radius: 999px;
      padding: 0.25rem 0.8rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    .btn-xs.btn-danger {
      border-color: #dc2626;
      color: #b91c1c;
    }

    .btn-xs.btn-danger:hover {
      background: #fef2f2;
    }

    .results-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.3rem 1rem;
      font-size: 0.88rem;
    }

    @media (max-width: 720px) {
      .results-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .result-label {
      color: #4b5563;
    }

    .result-value {
      font-weight: 600;
    }

    .result-value.red {
      color: #b91c1c;
    }

    .result-value.green {
      color: #15803d;
    }

    .total-bar {
      margin-top: 0.9rem;
      border-radius: 16px;
      padding: 0.6rem 1rem;
      background: linear-gradient(90deg, #0165b5, #059669);
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
    }

    .storico-panel-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .storico-description {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 0.7rem;
    }

    .storico-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.55rem 0;
      border-top: 1px solid #e5e7eb;
      gap: 0.5rem;
      font-size: 0.82rem;
    }

    .storico-main .storico-title {
      font-weight: 600;
      margin-bottom: 0.1rem;
    }

    .storico-main .storico-meta {
      color: #6b7280;
      font-size: 0.78rem;
      display: flex;
      gap: 0.7rem;
    }

    .storico-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER -->
    <header>
      <div class="container">
        <nav class="nav" id="nav">
          <div class="brand">
            <div class="brand-avatar">
              <img src="assets/img/Emir%20primo%20piano.jpg" alt="Emir Alili" />
            </div>
            <div class="brand-text">
              <strong>Emir Alili</strong>
              <span>Imprenditore, autore, leader politico</span>
            </div>
          </div>

          <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="chi-sono.html">Chi sono</a>
            <a href="cosa-faccio.html">Cosa faccio</a>
            <a href="contatti.html">Contatti</a>
          </div>

          <div class="nav-cta">
            <button class="btn-header" type="button" onclick="window.location.href='contatti.html'">
              Contatti
            </button>
          </div>

          <button class="nav-toggle" type="button" aria-label="Menu" id="navToggle">
            ☰
          </button>
        </nav>
      </div>
    </header>

    <!-- CONTENUTO -->
    <main>
      <div class="container">
        <section class="section-box">

          <!-- LOGO EA CLEANING -->
          <div class="logo-preventivi">
            <img src="assets/logos/Logo%20EA%20Cleaning.png" alt="EA Cleaning Services" />
          </div>

          <h1 class="page-title-center">Area preventivi</h1>
          <p class="page-subtitle-center">
            Strumento interno per calcolo, approvazione e archivio dei preventivi mensili EA Cleaning.
          </p>

          <!-- DATI CLIENTE -->
          <section class="panel">
            <div class="panel-title">Dati cliente</div>
            <div class="panel-grid">
              <div class="field">
                <label for="numPreventivo" class="field-label">Numero preventivo</label>
                <input type="text" id="numPreventivo" class="field-input" />
              </div>
              <div class="field">
                <label for="dataPreventivo" class="field-label">Data preventivo</label>
                <input type="date" id="dataPreventivo" class="field-input" />
              </div>
              <div class="field">
                <label for="ragioneSociale" class="field-label">Ragione sociale / Cliente</label>
                <input type="text" id="ragioneSociale" class="field-input" />
              </div>
              <div class="field">
                <label for="indirizzo" class="field-label">Indirizzo</label>
                <input type="text" id="indirizzo" class="field-input" />
              </div>
              <div class="field">
                <label for="telefono" class="field-label">Telefono</label>
                <input type="text" id="telefono" class="field-input" />
              </div>
              <div class="field">
                <label for="email" class="field-label">Email</label>
                <input type="email" id="email" class="field-input" />
              </div>
              <div class="field" style="grid-column: 1 / -1;">
                <label for="oggettoPreventivo" class="field-label">Oggetto preventivo</label>
                <input type="text" id="oggettoPreventivo" class="field-input" />
              </div>
              <div class="field" style="grid-column: 1 / -1;">
                <label for="descrizione" class="field-label">Descrizione</label>
                <textarea id="descrizione" class="field-textarea"></textarea>
              </div>
            </div>
          </section>

          <!-- PARAMETRI DI LAVORO -->
          <section class="panel">
            <div class="panel-title">Parametri di lavoro</div>

            <div class="panel-grid">
              <div class="field">
                <label for="interventiSett" class="field-label">Interventi settimanali</label>
                <div class="field-inline">
                  <input type="number" id="interventiSett" class="field-input" value="1" step="0.5" />
                  <span class="suffix">n° / settimana</span>
                </div>
              </div>

              <div class="field">
                <label for="oreIntervento" class="field-label">Ore per intervento</label>
                <div class="field-inline">
                  <input type="number" id="oreIntervento" class="field-input" value="1" step="0.25" />
                  <span class="suffix">ore</span>
                </div>
              </div>

              <div class="field" style="grid-column: 1 / -1;">
                <label class="field-label">Provvigione agente / intermediario</label>
                <div class="field-checkbox">
                  <input type="checkbox" id="flagProvvigione" />
                  <label for="flagProvvigione">Provvigione attiva</label>
                </div>
                <div class="field-inline" style="margin-top:0.3rem;">
                  <input type="number" id="provvigionePerc" class="field-input" value="0" />
                  <span class="suffix">% sul prezzo finale</span>
                </div>
              </div>

              <div class="field">
                <div class="field-checkbox">
                  <input type="checkbox" id="flagSubappalto" />
                  <label for="flagSubappalto">Subappalto (costo 16 €/h)</label>
                </div>
              </div>

              <div class="field">
                <div class="field-checkbox">
                  <input type="checkbox" id="flagCostoInterno" />
                  <label for="flagCostoInterno">Costo orario interno</label>
                </div>
                <div class="field-inline" style="margin-top:0.3rem;">
                  <input type="number" id="costoOrarioInterno" class="field-input" value="23" />
                  <span class="suffix">€/h</span>
                </div>
                <div class="field-sublabel">
                  Per il lavoro interno il costo orario base è 23 €/h (modificabile).
                </div>
              </div>

              <div class="field">
                <label class="field-label">Costo prodotti</label>
                <div class="field-sublabel">10% automatico sul costo lavoro.</div>
              </div>

              <div class="field">
                <div class="field-checkbox">
                  <input type="checkbox" id="flagAttrezzature" />
                  <label for="flagAttrezzature">Attrezzature / noleggi</label>
                </div>
                <div class="field-inline" style="margin-top:0.3rem;">
                  <input type="number" id="costoAttrezzature" class="field-input" value="0" />
                  <span class="suffix">€/mese</span>
                </div>
              </div>
            </div>

            <div class="panel-buttons">
              <button type="button" class="btn-primary" id="calcolaBtn">Calcola preventivo</button>
              <button type="button" class="btn-outline" id="pdfInternoBtn">Esporta PDF (interno)</button>
              <button type="button" class="btn-outline" id="pdfClienteBtn">PDF cliente</button>
              <button type="button" class="btn-dashed" id="approvaBtn">Approva (salva storico)</button>
              <button type="button" class="btn-outline" id="resetBtn">Reset</button>
            </div>
          </section>

          <!-- RIEPILOGO ECONOMICO -->
          <section class="panel">
            <div class="panel-title">Riepilogo economico mensile</div>
            <div class="results-grid">
              <div class="result-row">
                <span class="result-label">Ore totali mese</span>
                <span class="result-value" id="oreMese">0,00 h</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo lavoro</span>
                <span class="result-value red" id="costoLavoro">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo prodotti (10%)</span>
                <span class="result-value red" id="costoProdotti">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo attrezzature</span>
                <span class="result-value red" id="costoAttrezzatureRes">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Provvigione</span>
                <span class="result-value red" id="costoProvvigione">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo totale aziendale</span>
                <span class="result-value red" id="costoTotale">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Tariffa oraria</span>
                <span class="result-value green" id="prezzoOrarioRes">0,00 €/h</span>
              </div>

              <div class="result-row">
                <span class="result-label">Ricavo lavoro (solo ore)</span>
                <span class="result-value green" id="ricavoLavoro">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Guadagno netto</span>
                <span class="result-value green" id="guadagnoNetto">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Guadagno netto %</span>
                <span class="result-value green" id="guadagnoPerc">0,0 %</span>
              </div>
            </div>

            <div class="total-bar">
              <span>Totale mensile da proporre al cliente</span>
              <span id="prezzoTotaleCliente">0,00 €</span>
            </div>
          </section>

          <!-- STORICO PREVENTIVI -->
          <section class="panel">
            <div class="storico-panel-title">Preventivi storici (solo su questo dispositivo)</div>
            <p class="storico-description">
              Ogni preventivo approvato viene salvato localmente. Puoi riaprirlo,
              ristampare i PDF o eliminarlo.
            </p>
            <div id="storicoList"></div>
          </section>
        </section>
      </div>
    </main>

    <!-- FOOTER -->
    <footer>
      <div class="container">
        <div class="footer-inner">
          <div class="footer-links">
            <span>© <span id="year"></span> Emir Alili.</span>
            <span>Strumento interno preventivi EA Cleaning.</span>
          </div>
          <div class="footer-social">
            <a href="mailto:info@emiralili.it">Email</a>
            <a href="https://www.facebook.com/emir.alili.81/" target="_blank" rel="noopener noreferrer">Facebook</a>
            <a href="https://www.linkedin.com/in/emiralili/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- jsPDF per i PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Anno footer
    document.getElementById("year").textContent = new Date().getFullYear();

    // Menu mobile
    const nav = document.getElementById("nav");
    const navToggle = document.getElementById("navToggle");
    if (nav && navToggle) {
      navToggle.addEventListener("click", function () {
        nav.classList.toggle("mobile-open");
      });
    }

    // ========= UTILITÀ DI FORMATO =========
    function formatEuro(val) {
      return val.toFixed(2).replace(".", ",") + " €";
    }

    function formatOre(val) {
      return val.toFixed(2).replace(".", ",") + " h";
    }

    function formatPerc(val) {
      return val.toFixed(1).replace(".", ",") + " %";
    }

    // ========= RIFERIMENTI CAMPI =========

    // Dati cliente
    const numPreventivoInput     = document.getElementById("numPreventivo");
    const dataPreventivoInput    = document.getElementById("dataPreventivo");
    const ragioneSocialeInput    = document.getElementById("ragioneSociale");
    const indirizzoInput         = document.getElementById("indirizzo");
    const telefonoInput          = document.getElementById("telefono");
    const emailInput             = document.getElementById("email");
    const oggettoInput           = document.getElementById("oggettoPreventivo");
    const descrizioneInput       = document.getElementById("descrizione");

    // Parametri di lavoro
    const interventiSettInput    = document.getElementById("interventiSett");
    const oreInterventoInput     = document.getElementById("oreIntervento");

    const flagProvvigione        = document.getElementById("flagProvvigione");
    const provvigionePercInput   = document.getElementById("provvigionePerc");

    const flagSubappalto         = document.getElementById("flagSubappalto");

    const flagCostoInterno       = document.getElementById("flagCostoInterno");
    const costoOrarioInput       = document.getElementById("costoOrarioInterno");

    const flagAttrezzature       = document.getElementById("flagAttrezzature");
    const costoAttrezzatureInput = document.getElementById("costoAttrezzature");

    // Risultati
    const oreMeseSpan              = document.getElementById("oreMese");
    const costoLavoroSpan          = document.getElementById("costoLavoro");
    const costoProdottiSpan        = document.getElementById("costoProdotti");
    const costoAttrezzatureResSpan = document.getElementById("costoAttrezzatureRes");
    const costoProvvigioneSpan     = document.getElementById("costoProvvigione");
    const costoTotaleSpan          = document.getElementById("costoTotale");
    const prezzoOrarioResSpan      = document.getElementById("prezzoOrarioRes");
    const ricavoLavoroSpan         = document.getElementById("ricavoLavoro");
    const guadagnoNettoSpan        = document.getElementById("guadagnoNetto");
    const guadagnoPercSpan         = document.getElementById("guadagnoPerc");
    const prezzoTotaleClienteSpan  = document.getElementById("prezzoTotaleCliente");

    // Storico
    const storicoListEl = document.getElementById("storicoList");
    const STORAGE_KEY   = "eaPreventiviStorico_v1";

    // Pulsanti
    const calcolaBtn     = document.getElementById("calcolaBtn");
    const pdfInternoBtn  = document.getElementById("pdfInternoBtn");
    const pdfClienteBtn  = document.getElementById("pdfClienteBtn");
    const approvaBtn     = document.getElementById("approvaBtn");
    const resetBtn       = document.getElementById("resetBtn");

    // ========= NUMERO E DATA PREVENTIVO =========

    function getTodayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function getNextNumeroPreventivo() {
      const year = new Date().getFullYear();
      const key  = "eaLastPreventivoNumber_v1";
      const last = localStorage.getItem(key);

      if (!last || last.indexOf(year + "-") !== 0) {
        const nuovo = `${year}-001`;
        localStorage.setItem(key, nuovo);
        return nuovo;
      }

      const parts = last.split("-");
      let seq = parseInt(parts[1], 10) || 0;
      seq += 1;
      const nuovo = `${parts[0]}-${String(seq).padStart(3, "0")}`;
      localStorage.setItem(key, nuovo);
      return nuovo;
    }

    // Inizializza numero e data se vuoti
    if (!numPreventivoInput.value) {
      numPreventivoInput.value = getNextNumeroPreventivo();
    }
    if (!dataPreventivoInput.value) {
      dataPreventivoInput.value = getTodayISO();
    }

    // ========= LOGICA CALCOLO =========
    //
    // Regole:
    // - oreMese = interventiSett * oreIntervento * 4,33
    // - lavoro interno:
    //      guadagnoTargetOrario = costoOrarioInterno (default 23)
    //      costoLavoro = 0
    //      profitTarget = guadagnoTargetOrario * oreMese
    // - subappalto:
    //      costoSubappaltoOrario = 16
    //      guadagnoTargetOrario  = 10
    //      costoLavoro  = 16 * oreMese
    //      profitTarget = 10 * oreMese
    // - baseLordoLavoro:
    //      interno:       profitTarget
    //      subappalto:    (16 + 10) * oreMese = 26 €/h * ore
    // - costoProdotti = 10% di baseLordoLavoro
    // - costoAttrezzature = campo (se attivo)
    // - baseSenzaProv = costoLavoro + costoProdotti + costoAttrezzature + profitTarget
    // - provvigione p% sul prezzo finale:
    //      prezzoFinale * (1 - p) = baseSenzaProv
    //      prezzoFinale = baseSenzaProv / (1 - p)
    //      provvigioneEuro = prezzoFinale * p
    // - costoTotaleAziendale = costoLavoro + costoProdotti + attrezzature + provvigione
    // - guadagnoNetto = prezzoFinale - costoTotaleAziendale = profitTarget

    function calcolaPreventivo() {
      const interventiSett = parseFloat(interventiSettInput.value) || 0;
      const oreIntervento  = parseFloat(oreInterventoInput.value) || 0;

      const oreMese = interventiSett * oreIntervento * 4.33;

      const provvigioneAttiva = flagProvvigione.checked;
      const provPerc          = provvigioneAttiva ? (parseFloat(provvigionePercInput.value) || 0) : 0;

      const subappaltoAttivo  = flagSubappalto.checked;
      const costoInternoFlag  = flagCostoInterno.checked;
      let   costoInternoOra   = parseFloat(costoOrarioInput.value) || 23;

      if (!costoInternoFlag) {
        costoInternoOra = 23;
        costoOrarioInput.value = "23";
      }

      const attrezzatureAttive = flagAttrezzature.checked;
      const costoAttrezzature  = attrezzatureAttive ? (parseFloat(costoAttrezzatureInput.value) || 0) : 0;

      const costoSubOra   = 16;
      const margineSubOra = 10;

      let costoLavoro     = 0;
      let profitTarget    = 0;
      let baseLordoLavoro = 0;

      if (subappaltoAttivo) {
        costoLavoro     = costoSubOra * oreMese;
        profitTarget    = margineSubOra * oreMese;
        baseLordoLavoro = (costoSubOra + margineSubOra) * oreMese; // 26 €/h
      } else {
        profitTarget    = costoInternoOra * oreMese;
        baseLordoLavoro = profitTarget;
        costoLavoro     = 0;
      }

      const costoProdotti = baseLordoLavoro * 0.10;

      const baseSenzaProv = costoLavoro + costoProdotti + costoAttrezzature + profitTarget;

      let prezzoFinale    = baseSenzaProv;
      let provvigioneEuro = 0;

      if (provvigioneAttiva && provPerc > 0) {
        const p = provPerc / 100;
        prezzoFinale    = baseSenzaProv / (1 - p);
        provvigioneEuro = prezzoFinale * p;
      }

      const costoTotale   = costoLavoro + costoProdotti + costoAttrezzature + provvigioneEuro;
      const guadagnoNetto = prezzoFinale - costoTotale;
      const guadagnoPerc  = prezzoFinale > 0 ? (guadagnoNetto / prezzoFinale) * 100 : 0;
      const tariffaOraria = oreMese > 0 ? prezzoFinale / oreMese : 0;
      const ricavoLavoro  = baseLordoLavoro;

      oreMeseSpan.textContent              = formatOre(oreMese);
      costoLavoroSpan.textContent          = formatEuro(costoLavoro);
      costoProdottiSpan.textContent        = formatEuro(costoProdotti);
      costoAttrezzatureResSpan.textContent = formatEuro(costoAttrezzature);
      costoProvvigioneSpan.textContent     = formatEuro(provvigioneEuro);
      costoTotaleSpan.textContent          = formatEuro(costoTotale);
      prezzoOrarioResSpan.textContent      = tariffaOraria.toFixed(2).replace(".", ",") + " €/h";
      ricavoLavoroSpan.textContent         = formatEuro(ricavoLavoro);
      guadagnoNettoSpan.textContent        = formatEuro(guadagnoNetto);
      guadagnoPercSpan.textContent         = formatPerc(guadagnoPerc);
      prezzoTotaleClienteSpan.textContent  = formatEuro(prezzoFinale);
    }

    // ========= RESET =========
    function resetCampi() {
      interventiSettInput.value  = 1;
      oreInterventoInput.value   = 1;

      flagProvvigione.checked    = false;
      provvigionePercInput.value = 0;

      flagSubappalto.checked     = false;

      flagCostoInterno.checked   = false;
      costoOrarioInput.value     = 23;

      flagAttrezzature.checked   = false;
      costoAttrezzatureInput.value = 0;

      calcolaPreventivo();
    }

    // ========= STORICO LOCALSTORAGE =========

    function loadStorico() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveStorico(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function renderStorico() {
      const lista = loadStorico();
      if (!lista.length) {
        storicoListEl.innerHTML =
          '<p style="font-size:0.8rem; color:#6b7280;">Nessun preventivo salvato. Dopo il calcolo usa "Approva (salva storico)".</p>';
        return;
      }

      storicoListEl.innerHTML = "";

      lista.forEach((p, index) => {
        const row = document.createElement("div");
        row.className = "storico-row";
        row.innerHTML = `
          <div class="storico-main">
            <div class="storico-title">
              <strong>${p.numero}</strong> – ${p.cliente || "Cliente senza nome"}
            </div>
            <div class="storico-meta">
              <span>${p.data}</span>
              <span>${formatEuro(p.prezzoTotale)}</span>
            </div>
          </div>
          <div class="storico-actions">
            <button type="button" class="btn-xs" data-idx="${index}" data-action="open">Apri</button>
            <button type="button" class="btn-xs" data-idx="${index}" data-action="pdf-int">PDF interno</button>
            <button type="button" class="btn-xs" data-idx="${index}" data-action="pdf-cli">PDF cliente</button>
            <button type="button" class="btn-xs btn-danger" data-idx="${index}" data-action="delete">Elimina</button>
          </div>
        `;
        storicoListEl.appendChild(row);
      });
    }

    function parseEuro(text) {
      if (!text) return 0;
      return parseFloat(
        text
          .replace("€", "")
          .replace(/\./g, "")
          .replace(",", ".")
          .trim()
      ) || 0;
    }

    function approvaPreventivo() {
      calcolaPreventivo();

      const lista = loadStorico();

      const record = {
        numero: numPreventivoInput.value || "",
        data: dataPreventivoInput.value || "",
        cliente: ragioneSocialeInput.value || "",
        indirizzo: indirizzoInput.value || "",
        telefono: telefonoInput.value || "",
        email: emailInput.value || "",
        oggetto: oggettoInput.value || "",
        descrizione: descrizioneInput.value || "",
        interventiSett: parseFloat(interventiSettInput.value) || 0,
        oreIntervento: parseFloat(oreInterventoInput.value) || 0,
        provvigioneAttiva: flagProvvigione.checked,
        provPerc: parseFloat(provvigionePercInput.value) || 0,
        subappaltoAttivo: flagSubappalto.checked,
        costoInternoFlag: flagCostoInterno.checked,
        costoInternoOra: parseFloat(costoOrarioInput.value) || 23,
        attrezzatureAttive: flagAttrezzature.checked,
        costoAttrezzature: parseFloat(costoAttrezzatureInput.value) || 0,
        oreMese: oreMeseSpan.textContent,
        costoLavoro: costoLavoroSpan.textContent,
        costoProdotti: costoProdottiSpan.textContent,
        costoAttrezzatureRes: costoAttrezzatureResSpan.textContent,
        costoProvvigione: costoProvvigioneSpan.textContent,
        costoTotale: costoTotaleSpan.textContent,
        prezzoOrarioRes: prezzoOrarioResSpan.textContent,
        ricavoLavoro: ricavoLavoroSpan.textContent,
        guadagnoNetto: guadagnoNettoSpan.textContent,
        guadagnoPerc: guadagnoPercSpan.textContent,
        prezzoTotaleClienteText: prezzoTotaleClienteSpan.textContent,
        prezzoTotale: parseEuro(prezzoTotaleClienteSpan.textContent)
      };

      lista.push(record);
      saveStorico(lista);
      renderStorico();

      numPreventivoInput.value = getNextNumeroPreventivo();
    }

    // ========= PDF =========

    function getJsPdf() {
      return window.jspdf.jsPDF;
    }

    function generaPdfInternoDaValori(
      numero, data, cliente, indirizzo, telefono, email,
      oggetto, descrizione
    ) {
      const jsPDF = getJsPdf();
      const doc = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });

      let y = 20;
      const marginLeft = 15;
      const marginRight = 195;

      doc.setFontSize(16);
      doc.text("EA Cleaning – Preventivo interno", marginLeft, y);
      y += 7;

      doc.setFontSize(11);
      doc.text("Nr: " + (numero || ""), marginLeft, y);
      doc.text("Data: " + (data || ""), marginLeft + 70, y);
      y += 6;

      doc.text("Cliente: " + (cliente || ""), marginLeft, y);
      y += 5;
      if (indirizzo) {
        doc.text("Indirizzo: " + indirizzo, marginLeft, y);
        y += 5;
      }
      if (telefono) {
        doc.text("Telefono: " + telefono, marginLeft, y);
        y += 5;
      }
      if (email) {
        doc.text("Email: " + email, marginLeft, y);
        y += 6;
      }

      if (oggetto) {
        doc.setFontSize(12);
        doc.text("Oggetto: " + oggetto, marginLeft, y);
        y += 6;
      }

      if (descrizione) {
        doc.setFontSize(10);
        const descLines = doc.splitTextToSize("Descrizione: " + descrizione, marginRight - marginLeft);
        doc.text(descLines, marginLeft, y);
        y += descLines.length * 5 + 5;
      }

      doc.setFontSize(12);
      doc.text("Riepilogo economico mensile", marginLeft, y);
      y += 5;

      doc.setDrawColor(220, 220, 220);
      doc.line(marginLeft, y, marginRight, y);
      y += 4;

      function row(label, spanId, colorType) {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        const valText = document.getElementById(spanId).textContent || "0,00 €";
        if (colorType === "cost") {
          doc.setTextColor(185, 28, 28);
        } else if (colorType === "rev") {
          doc.setTextColor(22, 163, 74);
        } else {
          doc.setTextColor(55, 65, 81);
        }
        doc.setFontSize(10);
        doc.text(label, marginLeft, y);
        doc.text(valText, marginRight, y, { align: "right" });
        y += 4.5;
      }

      row("Ore totali mese", "oreMese", "neutral");
      row("Costo lavoro", "costoLavoro", "cost");
      row("Costo prodotti (10%)", "costoProdotti", "cost");
      row("Costo attrezzature", "costoAttrezzatureRes", "cost");
      row("Provvigione", "costoProvvigione", "cost");
      row("Costo totale aziendale", "costoTotale", "cost");
      y += 2;
      doc.line(marginLeft, y, marginRight, y);
      y += 4;
      row("Tariffa oraria", "prezzoOrarioRes", "rev");
      row("Ricavo lavoro (solo ore)", "ricavoLavoro", "rev");
      row("Guadagno netto", "guadagnoNetto", "rev");
      row("Guadagno netto %", "guadagnoPerc", "rev");

      y += 8;
      doc.setFillColor(22, 163, 74);
      doc.setTextColor(255, 255, 255);
      doc.roundedRect(marginLeft, y - 7, 180, 12, 2, 2, "F");
      doc.setFontSize(11);
      doc.text("Totale mensile da proporre al cliente", marginLeft + 3, y - 1);
      const totText = prezzoTotaleClienteSpan.textContent || "0,00 €";
      doc.text(totText, marginRight - 3, y - 1, { align: "right" });

      const fileName = (numero || "preventivo-interno") + "_interno.pdf";
      doc.save(fileName);
    }

    function generaPdfClienteDaValori(
      numero, data, cliente, indirizzo, telefono, email,
      oggetto, descrizione, prezzoTotale
    ) {
      const jsPDF = getJsPdf();
      const doc = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });

      let y = 20;
      const marginLeft = 20;
      const marginRight = 190;

      doc.setFontSize(16);
      doc.text("EA Cleaning – Preventivo servizi di pulizia", marginLeft, y);
      y += 8;

      doc.setFontSize(11);
      doc.text("Nr: " + (numero || ""), marginLeft, y);
      doc.text("Data: " + (data || ""), marginLeft + 80, y);
      y += 8;

      doc.setFontSize(11);
      doc.text("Spett.le " + (cliente || ""), marginLeft, y);
      y += 5;
      if (indirizzo) {
        doc.text(indirizzo, marginLeft, y);
        y += 5;
      }
      if (telefono) {
        doc.text("Tel: " + telefono, marginLeft, y);
        y += 5;
      }
      if (email) {
        doc.text("Email: " + email, marginLeft, y);
        y += 7;
      }

      if (oggetto) {
        doc.setFontSize(12);
        doc.text("Oggetto: " + oggetto, marginLeft, y);
        y += 7;
      }

      if (descrizione) {
        doc.setFontSize(10);
        const descLines = doc.splitTextToSize(descrizione, marginRight - marginLeft);
        doc.text(descLines, marginLeft, y);
        y += descLines.length * 5 + 8;
      }

      doc.setFontSize(12);
      doc.text("Proposta economica", marginLeft, y);
      y += 6;

      doc.setDrawColor(200, 200, 200);
      doc.rect(marginLeft, y, 150, 14);
      doc.setFontSize(11);
      doc.text("Totale mensile servizi di pulizia", marginLeft + 3, y + 5);
      doc.text(prezzoTotale || "0,00 €", marginLeft + 3, y + 11);

      y += 22;
      doc.setFontSize(9);
      doc.setTextColor(107, 114, 128);
      doc.text(
        "Il presente preventivo è valido 30 giorni dalla data di emissione salvo diverse indicazioni.",
        marginLeft,
        y
      );
      y += 5;
      doc.text(
        "Restiamo a disposizione per eventuali chiarimenti e per un sopralluogo dettagliato.",
        marginLeft,
        y
      );

      const fileName = (numero || "preventivo-cliente") + "_cliente.pdf";
      doc.save(fileName);
    }

    function generaPdfInternoCorrente() {
      generaPdfInternoDaValori(
        numPreventivoInput.value,
        dataPreventivoInput.value,
        ragioneSocialeInput.value,
        indirizzoInput.value,
        telefonoInput.value,
        emailInput.value,
        oggettoInput.value,
        descrizioneInput.value
      );
    }

    function generaPdfClienteCorrente() {
      const prezzoText = prezzoTotaleClienteSpan.textContent || "0,00 €";
      generaPdfClienteDaValori(
        numPreventivoInput.value,
        dataPreventivoInput.value,
        ragioneSocialeInput.value,
        indirizzoInput.value,
        telefonoInput.value,
        emailInput.value,
        oggettoInput.value,
        descrizioneInput.value,
        prezzoText
      );
    }

    // ========= EVENT LISTENERS =========

    calcolaBtn.addEventListener("click", calcolaPreventivo);
    resetBtn.addEventListener("click", resetCampi);
    approvaBtn.addEventListener("click", approvaPreventivo);

    pdfInternoBtn.addEventListener("click", function () {
      calcolaPreventivo();
      generaPdfInternoCorrente();
    });

    pdfClienteBtn.addEventListener("click", function () {
      calcolaPreventivo();
      generaPdfClienteCorrente();
    });

    [
      interventiSettInput,
      oreInterventoInput,
      provvigionePercInput,
      costoOrarioInput,
      costoAttrezzatureInput,
      flagProvvigione,
      flagSubappalto,
      flagCostoInterno,
      flagAttrezzature
    ].forEach(el => {
      el.addEventListener("input", calcolaPreventivo);
      el.addEventListener("change", calcolaPreventivo);
    });

    storicoListEl.addEventListener("click", function (e) {
      const btn = e.target.closest("button");
      if (!btn) return;
      const index  = parseInt(btn.dataset.idx, 10);
      const action = btn.dataset.action;
      const lista  = loadStorico();
      const rec    = lista[index];
      if (!rec) return;

      if (action === "delete") {
        lista.splice(index, 1);
        saveStorico(lista);
        renderStorico();
      } else if (action === "open") {
        numPreventivoInput.value   = rec.numero;
        dataPreventivoInput.value  = rec.data;
        ragioneSocialeInput.value  = rec.cliente;
        indirizzoInput.value       = rec.indirizzo;
        telefonoInput.value        = rec.telefono;
        emailInput.value           = rec.email;
        oggettoInput.value         = rec.oggetto;
        descrizioneInput.value     = rec.descrizione;

        interventiSettInput.value  = rec.interventiSett;
        oreInterventoInput.value   = rec.oreIntervento;
        flagProvvigione.checked    = rec.provvigioneAttiva;
        provvigionePercInput.value = rec.provPerc;
        flagSubappalto.checked     = rec.subappaltoAttivo;
        flagCostoInterno.checked   = rec.costoInternoFlag;
        costoOrarioInput.value     = rec.costoInternoOra;
        flagAttrezzature.checked   = rec.attrezzatureAttive;
        costoAttrezzatureInput.value = rec.costoAttrezzature;

        calcolaPreventivo();
      } else if (action === "pdf-int") {
        calcolaPreventivo();
        generaPdfInternoDaValori(
          rec.numero,
          rec.data,
          rec.cliente,
          rec.indirizzo,
          rec.telefono,
          rec.email,
          rec.oggetto,
          rec.descrizione
        );
      } else if (action === "pdf-cli") {
        calcolaPreventivo();
        generaPdfClienteDaValori(
          rec.numero,
          rec.data,
          rec.cliente,
          rec.indirizzo,
          rec.telefono,
          rec.email,
          rec.oggetto,
          rec.descrizione,
          rec.prezzoTotaleClienteText || formatEuro(rec.prezzoTotale)
        );
      }
    });

    // calcolo e storico iniziali
    calcolaPreventivo();
    renderStorico();
  </script>
</body>
</html>
