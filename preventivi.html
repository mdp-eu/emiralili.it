<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strumento preventivi – Emir Alili</title>

  <!-- Icone PWA (facoltative, non si rompono se il manifest manca) -->
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="/assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png" />

  <!-- Stile generale del sito -->
  <link rel="stylesheet" href="style.css" />

  <!-- Stile specifico della pagina preventivi -->
  <style>
    main {
      padding: 2.1rem 0 3.5rem;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container-narrow {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 1.1rem;
    }

    .logo-top {
      text-align: center;
      margin: 1.2rem 0 0.3rem;
    }

    .logo-top img {
      max-width: 220px;
      height: auto;
    }

    .page-title {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      margin-top: 0.4rem;
      color: #0f172a;
    }

    .page-subtitle {
      text-align: center;
      font-size: 0.95rem;
      color: #6b7280;
      margin-top: 0.25rem;
      margin-bottom: 1.2rem;
    }

    .panel {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.05);
      padding: 1.3rem 1.2rem 1.4rem;
      margin-bottom: 1rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: #111827;
    }

    .panel-subtitle {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }

    .field {
      margin-bottom: 0.7rem;
    }

    .field-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #111827;
    }

    .field-row {
      display: flex;
      gap: 0.55rem;
      align-items: center;
    }

    .field-input,
    .field-textarea {
      flex: 1;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 0.52rem 0.7rem;
      font-size: 0.9rem;
      outline: none;
      background: #ffffff;
    }

    .field-textarea {
      min-height: 70px;
      resize: vertical;
    }

    .field-input:focus,
    .field-textarea:focus {
      border-color: #0f6ecf;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .field-suffix {
      font-size: 0.8rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .field-inline {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.88rem;
      color: #111827;
      margin-bottom: 0.45rem;
    }

    .field-inline input[type="checkbox"] {
      transform: scale(1.1);
    }

    .field-muted {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }

    .two-cols {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 1.2rem;
    }

    @media (max-width: 880px) {
      .two-cols {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    .btn-main {
      border-radius: 999px;
      padding: 0.6rem 1.4rem;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #0369a1;
      color: #ffffff;
    }

    .btn-main:hover {
      background: #075985;
    }

    .btn-outline {
      border-radius: 999px;
      padding: 0.58rem 1.3rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      color: #111827;
    }

    .btn-outline:hover {
      background: #f9fafb;
    }

    .btn-soft {
      border-radius: 999px;
      padding: 0.58rem 1.3rem;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      color: #111827;
    }

    .results-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.25rem;
      font-size: 0.88rem;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.7rem;
    }

    .result-label {
      color: #4b5563;
    }

    .result-value {
      font-weight: 600;
      color: #111827;
    }

    .result-value.red {
      color: #b91c1c;
    }

    .result-value.green {
      color: #15803d;
    }

    .total-banner {
      margin-top: 0.8rem;
      padding: 0.75rem 0.9rem;
      border-radius: 14px;
      background: linear-gradient(90deg, #0369a1, #16a34a);
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .storico-panel {
      margin-top: 1.3rem;
    }

    .storico-list {
      margin-top: 0.7rem;
      border-top: 1px solid #e5e7eb;
    }

    .storico-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.55rem 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.86rem;
    }

    .storico-main {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .storico-num {
      font-weight: 600;
      color: #111827;
    }

    .storico-sub {
      color: #6b7280;
      font-size: 0.78rem;
    }

    .storico-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .storico-actions button {
      font-size: 0.78rem;
      padding: 0.32rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    .storico-actions button:hover {
      background: #f3f4f6;
    }

    footer {
      margin-top: auto;
      padding: 1.4rem 0 1.2rem;
      border-top: 1px solid #e5e7eb;
      font-size: 0.82rem;
      color: #6b7280;
    }

    footer .footer-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 1.1rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    footer a {
      color: inherit;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page">
    <main>
      <div class="container-narrow">

        <!-- Logo + titolo -->
        <div class="logo-top">
          <img src="assets/logos/Logo EA Cleaning.png" alt="EA Cleaning Services" />
        </div>
        <h1 class="page-title">Area preventivi</h1>
        <p class="page-subtitle">
          Strumento interno per calcolo, approvazione e archivio preventivi EA Cleaning.
        </p>

        <!-- DATI CLIENTE -->
        <section class="panel">
          <div class="panel-title">Dati cliente</div>

          <div class="two-cols">
            <div>
              <div class="field">
                <label class="field-label" for="numeroPreventivo">Numero preventivo</label>
                <input id="numeroPreventivo" class="field-input" type="text" />
              </div>

              <div class="field">
                <label class="field-label" for="dataPreventivo">Data preventivo</label>
                <input id="dataPreventivo" class="field-input" type="date" />
              </div>

              <div class="field">
                <label class="field-label" for="ragioneSociale">Ragione sociale / Cliente</label>
                <input id="ragioneSociale" class="field-input" type="text" />
              </div>

              <div class="field">
                <label class="field-label" for="indirizzoCliente">Indirizzo</label>
                <input id="indirizzoCliente" class="field-input" type="text" />
              </div>
            </div>

            <div>
              <div class="field">
                <label class="field-label" for="telefonoCliente">Telefono</label>
                <input id="telefonoCliente" class="field-input" type="text" />
              </div>

              <div class="field">
                <label class="field-label" for="emailCliente">Email</label>
                <input id="emailCliente" class="field-input" type="email" />
              </div>

              <div class="field">
                <label class="field-label" for="oggettoPreventivo">Oggetto preventivo</label>
                <input id="oggettoPreventivo" class="field-input" type="text" placeholder="Es. Pulizie condominio, uffici, ecc." />
              </div>

              <div class="field">
                <label class="field-label" for="descrizionePreventivo">Descrizione</label>
                <textarea id="descrizionePreventivo" class="field-textarea" placeholder="Descrizione sintetica del servizio offerto"></textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- PARAMETRI DI LAVORO + RISULTATI -->
        <div class="two-cols">
          <!-- Parametri -->
          <section class="panel">
            <div class="panel-title">Parametri di lavoro</div>

            <div class="field">
              <label class="field-label" for="interventiSett">Interventi settimanali</label>
              <div class="field-row">
                <input id="interventiSett" class="field-input" type="number" step="0.5" value="1" />
                <span class="field-suffix">n° / settimana</span>
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="oreIntervento">Ore per intervento</label>
              <div class="field-row">
                <input id="oreIntervento" class="field-input" type="number" step="0.25" value="1" />
                <span class="field-suffix">ore</span>
              </div>
            </div>

            <div class="field">
              <div class="field-inline">
                <input id="flagProvvigione" type="checkbox" />
                <label for="flagProvvigione">Provvigione agente / intermediario</label>
              </div>
              <div class="field-row">
                <input id="provvigionePerc" class="field-input" type="number" step="0.5" value="0" disabled />
                <span class="field-suffix">% sul prezzo finale</span>
              </div>
            </div>

            <div class="field">
              <div class="field-inline">
                <input id="flagSubappalto" type="checkbox" />
                <label for="flagSubappalto">Subappalto (costo 16 €/h)</label>
              </div>
            </div>

            <div class="field">
              <div class="field-inline">
                <input id="flagCostoInterno" type="checkbox" checked />
                <label for="flagCostoInterno">Costo orario interno</label>
              </div>
              <div class="field-row">
                <input id="costoOrarioInterno" class="field-input" type="number" step="0.5" value="23" />
                <span class="field-suffix">€/h</span>
              </div>
              <p class="field-muted">
                Per il lavoro interno il costo orario base è 23 €/h (modificabile).
              </p>
            </div>

            <div class="field">
              <label class="field-label">Costo prodotti</label>
              <p class="field-muted">10% automatico sul costo lavoro.</p>
            </div>

            <div class="field">
              <div class="field-inline">
                <input id="flagAttrezzature" type="checkbox" />
                <label for="flagAttrezzature">Attrezzature / noleggi</label>
              </div>
              <div class="field-row">
                <input id="costoAttrezzature" class="field-input" type="number" step="1" value="0" disabled />
                <span class="field-suffix">€/mese</span>
              </div>
            </div>

            <div class="buttons-row">
              <button id="calcolaBtn" class="btn-main" type="button">Calcola preventivo</button>
              <button id="pdfInternoBtn" class="btn-outline" type="button">Esporta PDF (interno)</button>
              <button id="pdfClienteBtn" class="btn-outline" type="button">PDF cliente</button>
              <button id="approvaBtn" class="btn-soft" type="button">Approva (salva storico)</button>
              <button id="resetBtn" class="btn-outline" type="button">Reset</button>
            </div>
          </section>

          <!-- Risultati -->
          <section class="panel">
            <div class="panel-title">Riepilogo economico mensile</div>

            <div class="results-grid">
              <div class="result-row">
                <span class="result-label">Ore totali mese</span>
                <span id="oreMeseRes" class="result-value">0,00 h</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo lavoro</span>
                <span id="costoLavoroRes" class="result-value red">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo prodotti (10%)</span>
                <span id="costoProdottiRes" class="result-value red">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo attrezzature</span>
                <span id="costoAttrezzatureResSpan" class="result-value red">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Provvigione</span>
                <span id="costoProvvigioneRes" class="result-value red">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Costo totale aziendale</span>
                <span id="costoTotaleRes" class="result-value red">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Tariffa oraria</span>
                <span id="prezzoOrarioRes" class="result-value green">0,00 €/h</span>
              </div>

              <div class="result-row">
                <span class="result-label">Ricavo lavoro (solo ore)</span>
                <span id="ricavoLavoroRes" class="result-value green">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Guadagno netto</span>
                <span id="guadagnoNettoRes" class="result-value green">0,00 €</span>
              </div>

              <div class="result-row">
                <span class="result-label">Guadagno netto %</span>
                <span id="guadagnoPercRes" class="result-value green">0,0 %</span>
              </div>
            </div>

            <div class="total-banner">
              <span>Totale mensile da proporre al cliente</span>
              <span id="prezzoTotaleClienteRes">0,00 €</span>
            </div>
          </section>
        </div>

        <!-- STORICO PREVENTIVI -->
        <section class="panel storico-panel">
          <div class="panel-title">Preventivi storici (solo su questo dispositivo)</div>
          <div class="panel-subtitle">
            Ogni preventivo approvato viene salvato localmente. Puoi riaprirlo, ristampare i PDF o eliminarlo.
          </div>

          <div id="storicoList" class="storico-list"></div>
        </section>

      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <span>© <span id="year"></span> Emir Alili – EA Cleaning Services.</span>
        <span>Strumento interno preventivi EA Cleaning.</span>
      </div>
    </footer>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ====== UTIL ======
    document.getElementById("year").textContent = new Date().getFullYear();

    function formatEuro(val) {
      return (val || 0).toFixed(2).replace(".", ",") + " €";
    }

    function formatOre(val) {
      return (val || 0).toFixed(2).replace(".", ",") + " h";
    }

    function formatPerc(val) {
      return (val || 0).toFixed(1).replace(".", ",") + " %";
    }

    function todayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function nextNumeroPreventivo() {
      const year = new Date().getFullYear();
      const key = "eaPrevLastNumero";
      const last = localStorage.getItem(key);
      if (!last || !last.startsWith(year + "-")) {
        const nuovo = year + "-001";
        localStorage.setItem(key, nuovo);
        return nuovo;
      }
      const parts = last.split("-");
      let seq = parseInt(parts[1], 10) || 0;
      seq += 1;
      let seqStr = String(seq);
      while (seqStr.length < 3) seqStr = "0" + seqStr;
      const nuovo = `${parts[0]}-${seqStr}`;
      localStorage.setItem(key, nuovo);
      return nuovo;
    }

    // ====== DOM RIFERIMENTI ======
    const numeroPreventivoInput = document.getElementById("numeroPreventivo");
    const dataPreventivoInput = document.getElementById("dataPreventivo");
    const ragioneSocialeInput = document.getElementById("ragioneSociale");
    const indirizzoClienteInput = document.getElementById("indirizzoCliente");
    const telefonoClienteInput = document.getElementById("telefonoCliente");
    const emailClienteInput = document.getElementById("emailCliente");
    const oggettoPreventivoInput = document.getElementById("oggettoPreventivo");
    const descrizionePreventivoInput = document.getElementById("descrizionePreventivo");

    const interventiSettInput = document.getElementById("interventiSett");
    const oreInterventoInput = document.getElementById("oreIntervento");
    const flagProvvigione = document.getElementById("flagProvvigione");
    const provvigionePercInput = document.getElementById("provvigionePerc");
    const flagSubappalto = document.getElementById("flagSubappalto");
    const flagCostoInterno = document.getElementById("flagCostoInterno");
    const costoOrarioInternoInput = document.getElementById("costoOrarioInterno");
    const flagAttrezzature = document.getElementById("flagAttrezzature");
    const costoAttrezzatureInput = document.getElementById("costoAttrezzature");

    const oreMeseSpan = document.getElementById("oreMeseRes");
    const costoLavoroSpan = document.getElementById("costoLavoroRes");
    const costoProdottiSpan = document.getElementById("costoProdottiRes");
    const costoAttrezzatureResSpan = document.getElementById("costoAttrezzatureResSpan");
    const costoProvvigioneSpan = document.getElementById("costoProvvigioneRes");
    const costoTotaleSpan = document.getElementById("costoTotaleRes");
    const prezzoOrarioSpan = document.getElementById("prezzoOrarioRes");
    const ricavoLavoroSpan = document.getElementById("ricavoLavoroRes");
    const guadagnoNettoSpan = document.getElementById("guadagnoNettoRes");
    const guadagnoPercSpan = document.getElementById("guadagnoPercRes");
    const prezzoTotaleClienteSpan = document.getElementById("prezzoTotaleClienteRes");

    const storicoListEl = document.getElementById("storicoList");

    const calcolaBtn = document.getElementById("calcolaBtn");
    const pdfInternoBtn = document.getElementById("pdfInternoBtn");
    const pdfClienteBtn = document.getElementById("pdfClienteBtn");
    const approvaBtn = document.getElementById("approvaBtn");
    const resetBtn = document.getElementById("resetBtn");

    // Inizializza numero e data se vuoti
    if (!numeroPreventivoInput.value) {
      numeroPreventivoInput.value = nextNumeroPreventivo();
    }
    if (!dataPreventivoInput.value) {
      dataPreventivoInput.value = todayISO();
    }

    // Abilitazioni
    flagProvvigione.addEventListener("change", () => {
      provvigionePercInput.disabled = !flagProvvigione.checked;
      if (!flagProvvigione.checked) provvigionePercInput.value = 0;
      calcola();
    });

    flagAttrezzature.addEventListener("change", () => {
      costoAttrezzatureInput.disabled = !flagAttrezzature.checked;
      if (!flagAttrezzature.checked) costoAttrezzatureInput.value = 0;
      calcola();
    });

    flagCostoInterno.addEventListener("change", () => {
      costoOrarioInternoInput.disabled = !flagCostoInterno.checked;
      calcola();
    });

    flagSubappalto.addEventListener("change", calcola);

    [interventiSettInput, oreInterventoInput, provvigionePercInput,
     costoOrarioInternoInput, costoAttrezzatureInput].forEach(el => {
      el.addEventListener("input", calcola);
    });

    // ====== CALCOLO ======
    function calcola() {
      const interventiSett = parseFloat(interventiSettInput.value) || 0;
      const oreIntervento = parseFloat(oreInterventoInput.value) || 0;
      const provvPerc = flagProvvigione.checked ? (parseFloat(provvigionePercInput.value) || 0) : 0;
      const costoAttrezzature = flagAttrezzature.checked ? (parseFloat(costoAttrezzatureInput.value) || 0) : 0;
      const costoInterno = flagCostoInterno.checked ? (parseFloat(costoOrarioInternoInput.value) || 0) : 23;

      // Ore mese
      const oreMese = interventiSett * oreIntervento * 4.33;

      // Profilo lavoro: interno vs subappalto
      let costoOraProf = costoInterno;
      let margineTargetOra;

      if (flagSubappalto.checked) {
        // Subappalto: costo 16, guadagno target 10 €/h
        costoOraProf = 16;
        margineTargetOra = 10;
      } else {
        // Lavoro interno: guadagno netto target 23 €/h (al netto di provvigione)
        margineTargetOra = 23;
      }

      const costoLavoro = oreMese * costoOraProf;
      const costoProdotti = costoLavoro * 0.10;
      const costoBase = costoLavoro + costoProdotti + costoAttrezzature;

      const margineTargetTot = margineTargetOra * oreMese;

      let prezzoFinale;
      if (provvPerc > 0 && provvPerc < 100) {
        prezzoFinale = (costoBase + margineTargetTot) / (1 - provvPerc / 100);
      } else {
        prezzoFinale = costoBase + margineTargetTot;
      }

      if (!isFinite(prezzoFinale) || prezzoFinale < 0) prezzoFinale = 0;

      const provvigioneEuro = prezzoFinale * (provvPerc / 100);
      const costoTotale = costoBase + provvigioneEuro;
      const guadagnoNetto = prezzoFinale - costoTotale;
      const guadagnoPerc = prezzoFinale > 0 ? (guadagnoNetto / prezzoFinale) * 100 : 0;
      const prezzoOrario = oreMese > 0 ? prezzoFinale / oreMese : 0;

      // Ricavo lavoro: parte del prezzo che rimane dopo prodotti/attrezzature/provvigione
      const ricavoLavoro = prezzoFinale - costoProdotti - costoAttrezzature - provvigioneEuro;

      // Aggiorna UI
      oreMeseSpan.textContent = formatOre(oreMese);
      costoLavoroSpan.textContent = formatEuro(costoLavoro);
      costoProdottiSpan.textContent = formatEuro(costoProdotti);
      costoAttrezzatureResSpan.textContent = formatEuro(costoAttrezzature);
      costoProvvigioneSpan.textContent = formatEuro(provvigioneEuro);
      costoTotaleSpan.textContent = formatEuro(costoTotale);
      prezzoOrarioSpan.textContent = prezzoOrario.toFixed(2).replace(".", ",") + " €/h";
      ricavoLavoroSpan.textContent = formatEuro(ricavoLavoro);
      guadagnoNettoSpan.textContent = formatEuro(guadagnoNetto);
      guadagnoPercSpan.textContent = formatPerc(guadagnoPerc);
      prezzoTotaleClienteSpan.textContent = formatEuro(prezzoFinale);

      // Restituisce i dati utili alle funzioni PDF/storico
      return {
        oreMese,
        costoLavoro,
        costoProdotti,
        costoAttrezzature,
        provvigioneEuro,
        costoTotale,
        guadagnoNetto,
        guadagnoPerc,
        prezzoOrario,
        prezzoTotaleCliente: prezzoFinale,
        ricavoLavoro
      };
    }

    // Prima esecuzione
    calcola();

    // ====== STORICO (LOCALSTORAGE) ======
    const STORAGE_KEY = "eaPreventiviStorico";

    function loadStorico() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveStorico(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function renderStorico() {
      const lista = loadStorico();
      if (!lista.length) {
        storicoListEl.innerHTML =
          '<p style="font-size:0.8rem; color:#6b7280; padding:0.5rem 0;">Nessun preventivo salvato. Dopo averlo calcolato, usa “Approva (salva storico)”.</p>';
        return;
      }

      storicoListEl.innerHTML = "";
      lista
        .sort((a, b) => (a.numero > b.numero ? -1 : 1))
        .forEach(item => {
          const row = document.createElement("div");
          row.className = "storico-item";

          const main = document.createElement("div");
          main.className = "storico-main";

          const num = document.createElement("div");
          num.className = "storico-num";
          num.textContent = `${item.numero} – ${item.cliente || "Senza nome"}`;

          const sub = document.createElement("div");
          sub.className = "storico-sub";
          sub.textContent =
            `${item.data || ""} · ${item.oggetto || ""} · Totale: ${formatEuro(item.prezzoTotaleCliente || 0)}`;

          main.appendChild(num);
          main.appendChild(sub);

          const actions = document.createElement("div");
          actions.className = "storico-actions";

          const btnApri = document.createElement("button");
          btnApri.textContent = "Apri";
          btnApri.addEventListener("click", () => {
            caricaPreventivo(item.id);
          });

          const btnPdfInterno = document.createElement("button");
          btnPdfInterno.textContent = "PDF interno";
          btnPdfInterno.addEventListener("click", () => {
            esportaPdfInterno(item, true);
          });

          const btnPdfCliente = document.createElement("button");
          btnPdfCliente.textContent = "PDF cliente";
          btnPdfCliente.addEventListener("click", () => {
            esportaPdfCliente(item, true);
          });

          const btnElimina = document.createElement("button");
          btnElimina.textContent = "Elimina";
          btnElimina.addEventListener("click", () => {
            eliminaPreventivo(item.id);
          });

          actions.appendChild(btnApri);
          actions.appendChild(btnPdfInterno);
          actions.appendChild(btnPdfCliente);
          actions.appendChild(btnElimina);

          row.appendChild(main);
          row.appendChild(actions);

          storicoListEl.appendChild(row);
        });
    }

    function raccogliDatiPreventivo(includeCalcolo = true) {
      const base = {
        id: Date.now(),
        numero: numeroPreventivoInput.value || "",
        data: dataPreventivoInput.value || "",
        cliente: ragioneSocialeInput.value || "",
        indirizzo: indirizzoClienteInput.value || "",
        telefono: telefonoClienteInput.value || "",
        email: emailClienteInput.value || "",
        oggetto: oggettoPreventivoInput.value || "",
        descrizione: descrizionePreventivoInput.value || "",
        interventiSett: parseFloat(interventiSettInput.value) || 0,
        oreIntervento: parseFloat(oreInterventoInput.value) || 0,
        flagProvvigione: flagProvvigione.checked,
        provvigionePerc: flagProvvigione.checked ? (parseFloat(provvigionePercInput.value) || 0) : 0,
        flagSubappalto: flagSubappalto.checked,
        flagCostoInterno: flagCostoInterno.checked,
        costoOrarioInterno: parseFloat(costoOrarioInternoInput.value) || 23,
        flagAttrezzature: flagAttrezzature.checked,
        costoAttrezzature: flagAttrezzature.checked ? (parseFloat(costoAttrezzatureInput.value) || 0) : 0
      };

      if (!includeCalcolo) return base;

      const calcoloRis = calcola();
      return {
        ...base,
        ...calcoloRis
      };
    }

    function caricaPreventivo(id) {
      const lista = loadStorico();
      const item = lista.find(p => p.id === id);
      if (!item) return;

      numeroPreventivoInput.value = item.numero || "";
      dataPreventivoInput.value = item.data || todayISO();
      ragioneSocialeInput.value = item.cliente || "";
      indirizzoClienteInput.value = item.indirizzo || "";
      telefonoClienteInput.value = item.telefono || "";
      emailClienteInput.value = item.email || "";
      oggettoPreventivoInput.value = item.oggetto || "";
      descrizionePreventivoInput.value = item.descrizione || "";

      interventiSettInput.value = item.interventiSett || 0;
      oreInterventoInput.value = item.oreIntervento || 0;

      flagProvvigione.checked = !!item.flagProvvigione;
      provvigionePercInput.disabled = !flagProvvigione.checked;
      provvigionePercInput.value = item.provvigionePerc || 0;

      flagSubappalto.checked = !!item.flagSubappalto;

      flagCostoInterno.checked = !!item.flagCostoInterno;
      costoOrarioInternoInput.disabled = !flagCostoInterno.checked;
      costoOrarioInternoInput.value = item.costoOrarioInterno || 23;

      flagAttrezzature.checked = !!item.flagAttrezzature;
      costoAttrezzatureInput.disabled = !flagAttrezzature.checked;
      costoAttrezzatureInput.value = item.costoAttrezzature || 0;

      calcola();
    }

    function eliminaPreventivo(id) {
      const lista = loadStorico().filter(p => p.id !== id);
      saveStorico(lista);
      renderStorico();
    }

    // Approva / salva
    approvaBtn.addEventListener("click", () => {
      const dati = raccogliDatiPreventivo(true);
      const lista = loadStorico();
      lista.push(dati);
      saveStorico(lista);
      renderStorico();

      // avanzamento numero solo quando approvi
      numeroPreventivoInput.value = nextNumeroPreventivo();
    });

    renderStorico();

    // Reset
    resetBtn.addEventListener("click", () => {
      ragioneSocialeInput.value = "";
      indirizzoClienteInput.value = "";
      telefonoClienteInput.value = "";
      emailClienteInput.value = "";
      oggettoPreventivoInput.value = "";
      descrizionePreventivoInput.value = "";

      interventiSettInput.value = 1;
      oreInterventoInput.value = 1;
      flagProvvigione.checked = false;
      provvigionePercInput.disabled = true;
      provvigionePercInput.value = 0;
      flagSubappalto.checked = false;
      flagCostoInterno.checked = true;
      costoOrarioInternoInput.disabled = false;
      costoOrarioInternoInput.value = 23;
      flagAttrezzature.checked = false;
      costoAttrezzatureInput.disabled = true;
      costoAttrezzatureInput.value = 0;

      calcola();
    });

    // Calcola
    calcolaBtn.addEventListener("click", calcola);

    // ====== PDF INTERNO ======
    function esportaPdfInterno(dataOverride, fromStorico) {
      const dati = dataOverride || raccogliDatiPreventivo(true);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });

      let y = 18;
      const marginLeft = 15;
      const marginRight = 195;

      doc.setFontSize(14);
      doc.setTextColor(15, 23, 42);
      doc.text("EA Cleaning – Preventivo interno", marginLeft, y);
      y += 7;

      doc.setFontSize(10);
      doc.text(`Numero: ${dati.numero || ""}`, marginLeft, y);
      doc.text(`Data: ${dati.data || ""}`, marginLeft + 70, y);
      y += 5;

      doc.text(`Cliente: ${dati.cliente || ""}`, marginLeft, y);
      y += 5;
      if (dati.indirizzo) {
        doc.text(`Indirizzo: ${dati.indirizzo}`, marginLeft, y);
        y += 5;
      }
      if (dati.oggetto) {
        doc.text(`Oggetto: ${dati.oggetto}`, marginLeft, y);
        y += 7;
      }

      // Parametri
      doc.setFontSize(11);
      doc.text("Parametri di lavoro", marginLeft, y);
      y += 4;
      doc.setDrawColor(209, 213, 219);
      doc.line(marginLeft - 2, y, marginRight, y);
      y += 4;

      doc.setFontSize(9);
      doc.setTextColor(55, 65, 81);

      function addRow(label, value) {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.text(label, marginLeft, y);
        doc.text(value || "", marginRight, y, { align: "right" });
        y += 4;
      }

      addRow("Interventi settimanali", `${dati.interventiSett || 0}`);
      addRow("Ore per intervento", `${dati.oreIntervento || 0}`);
      addRow("Profilo lavoro", dati.flagSubappalto ? "Subappalto (16 €/h + 10 €/h)" : "Lavoro interno");
      addRow("Costo orario profilo", (dati.flagSubappalto ? "26,00 €/h (16+10)" :
        ((dati.costoOrarioInterno || 23).toFixed(2).replace(".", ",") + " €/h")));
      addRow("Provvigione", (dati.flagProvvigione ? `${dati.provvigionePerc || 0} %` : "0 %"));
      addRow("Costo attrezzature mese", formatEuro(dati.costoAttrezzature || 0));

      y += 4;
      doc.setFontSize(11);
      doc.setTextColor(15, 23, 42);
      doc.text("Riepilogo economico mensile", marginLeft, y);
      y += 4;
      doc.setDrawColor(209, 213, 219);
      doc.line(marginLeft - 2, y, marginRight, y);
      y += 4;

      doc.setFontSize(9);
      doc.setTextColor(55, 65, 81);

      addRow("Ore totali mese", formatOre(dati.oreMese || 0));
      addRow("Costo lavoro", formatEuro(dati.costoLavoro || 0));
      addRow("Costo prodotti (10%)", formatEuro(dati.costoProdotti || 0));
      addRow("Costo attrezzature", formatEuro(dati.costoAttrezzature || 0));
      addRow("Provvigione", formatEuro(dati.provvigioneEuro || 0));
      addRow("Costo totale aziendale", formatEuro(dati.costoTotale || 0));

      y += 3;
      doc.setDrawColor(156, 163, 175);
      doc.line(marginLeft - 2, y, marginRight, y);
      y += 5;

      addRow("Tariffa oraria", (dati.prezzoOrario || 0).toFixed(2).replace(".", ",") + " €/h");
      addRow("Ricavo lavoro (solo ore)", formatEuro(dati.ricavoLavoro || 0));
      addRow("Guadagno netto", formatEuro(dati.guadagnoNetto || 0));
      addRow("Guadagno netto %", formatPerc(dati.guadagnoPerc || 0));
      addRow("Totale mensile da proporre al cliente", formatEuro(dati.prezzoTotaleCliente || 0));

      const fileName = (dati.numero || "preventivo-interno") + "-interno.pdf";
      doc.save(fileName);
    }

    pdfInternoBtn.addEventListener("click", () => esportaPdfInterno());

    // ====== PDF CLIENTE ======
    function esportaPdfCliente(dataOverride, fromStorico) {
      const dati = dataOverride || raccogliDatiPreventivo(true);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });

      let y = 18;
      const marginLeft = 15;
      const marginRight = 195;

      // Intestazione EA GROUP
      doc.setFontSize(11);
      doc.setTextColor(55, 65, 81);
      doc.text("EA GROUP – EA Cleaning Services", marginRight, y, { align: "right" });
      y += 5;
      doc.text("Via Nievo 1 – 47035 Gambettola (FC)", marginRight, y, { align: "right" });
      y += 5;
      doc.text("ea@eagroup-servizi.com", marginRight, y, { align: "right" });
      y += 5;
      doc.text("www.eagroup-servizi.com", marginRight, y, { align: "right" });

      // Destinatario
      y = 30;
      doc.setFontSize(11);
      doc.setTextColor(15, 23, 42);
      doc.text("Spett.le", marginLeft, y);
      y += 5;
      doc.text(dati.cliente || "", marginLeft, y);
      y += 5;
      if (dati.indirizzo) {
        doc.text(dati.indirizzo, marginLeft, y);
        y += 5;
      }

      // Data e titolo "Preventivo"
      y += 3;
      doc.setFontSize(10);
      doc.text(`Data: ${dati.data || ""}`, marginLeft, y);
      y += 7;

      doc.setFontSize(14);
      doc.text("Preventivo", marginLeft, y);
      y += 8;

      // Oggetto
      doc.setFontSize(11);
      const ogg = dati.oggetto || "Servizio ordinario di pulizie";
      doc.text(`Oggetto: Offerta per ${ogg}`, marginLeft, y);
      y += 8;

      // Testo corpo (parafrasi modello Pioppa Uno)
      doc.setFontSize(10);
      doc.setTextColor(55, 65, 81);

      const testo1 =
        "A seguito dei contatti intercorsi e del sopralluogo effettuato, sottoponiamo alla Vostra attenzione la nostra offerta per l'esecuzione " +
        "dei servizi di pulizia degli spazi indicati.";
      const testo2 =
        "EA GROUP si impegna a svolgere i lavori con personale proprio qualificato, attrezzature idonee e prodotti a ridotto impatto ambientale. " +
        "Se necessario ci potremo avvalere di collaborazioni esterne, che resteranno comunque sotto la nostra piena responsabilità.";
      const testo3 =
        "Restano a carico della committenza la fornitura di energia elettrica e acqua necessarie allo svolgimento del servizio.";

      const t1 = doc.splitTextToSize(testo1, 180);
      const t2 = doc.splitTextToSize(testo2, 180);
      const t3 = doc.splitTextToSize(testo3, 180);

      doc.text(t1, marginLeft, y);
      y += t1.length * 4 + 3;
      doc.text(t2, marginLeft, y);
      y += t2.length * 4 + 3;
      doc.text(t3, marginLeft, y);
      y += t3.length * 4 + 6;

      // Descrizione servizio
      doc.setFontSize(11);
      doc.setTextColor(15, 23, 42);
      doc.text("Descrizione del servizio", marginLeft, y);
      y += 5;
      doc.setDrawColor(209, 213, 219);
      doc.line(marginLeft - 2, y, marginRight, y);
      y += 5;

      doc.setFontSize(10);
      doc.setTextColor(55, 65, 81);

      let descr = dati.descrizione || "";
      if (!descr) {
        descr = "Servizio di pulizia ordinaria degli ambienti comuni secondo capitolato concordato.";
      }
      const dLines = doc.splitTextToSize(descr, 180);
      doc.text(dLines, marginLeft, y);
      y += dLines.length * 4 + 6;

      // Frequenza
      const freqDesc = `Frequenza prevista: ${dati.interventiSett || 0} intervento/i settimanale/i da ${dati.oreIntervento || 0} ora/e per intervento.`;
      const fLines = doc.splitTextToSize(freqDesc, 180);
      doc.text(fLines, marginLeft, y);
      y += fLines.length * 4 + 8;

      // Prezzo
      doc.setFontSize(11);
      doc.setTextColor(15, 23, 42);
      const prezzoTxt = `Il servizio verrà svolto al costo mensile di Euro ${formatEuro(dati.prezzoTotaleCliente || 0).replace(" €", "")} oltre IVA.`;
      const pLines = doc.splitTextToSize(prezzoTxt, 180);
      doc.text(pLines, marginLeft, y);
      y += pLines.length * 5 + 8;

      // Accettazione
      doc.setFontSize(10);
      doc.setTextColor(55, 65, 81);
      const acc =
        "In caso di accettazione Vi chiediamo di restituire copia del presente preventivo timbrata e firmata, oppure di inviare conferma " +
        "scritta via email ai nostri recapiti.";
      const aLines = doc.splitTextToSize(acc, 180);
      doc.text(aLines, marginLeft, y);
      y += aLines.length * 4 + 10;

      doc.text("Restiamo a disposizione per ogni chiarimento e porgiamo cordiali saluti.", marginLeft, y);
      y += 10;

      doc.text("EA GROUP – EA Cleaning Services", marginLeft, y);
      y += 20;

      doc.setDrawColor(156, 163, 175);
      doc.line(marginLeft, y, marginLeft + 70, y);
      y += 4;
      doc.text("Per accettazione", marginLeft, y);

      const fileName = (dati.numero || "preventivo-cliente") + "-cliente.pdf";
      doc.save(fileName);
    }

    pdfClienteBtn.addEventListener("click", () => esportaPdfCliente());
  </script>
</body>
</html>
