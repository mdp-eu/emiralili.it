<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Area preventivi – EA Cleaning</title>

  <style>
    :root {
      --bg-page:#f3f4f6;
      --bg-main:#ffffff;
      --bg-soft:#f9fafb;
      --text-main:#0f172a;
      --text-muted:#6b7280;
      --border-subtle:#e5e7eb;
      --accent:#1d4ed8;
      --danger:#b91c1c;
      --positive:#16a34a;
      --radius-lg:18px;
      --radius-full:999px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
      line-height:1.5;
    }
    img{max-width:100%;display:block}
    .page{min-height:100vh;display:flex;flex-direction:column}
    .container{
      width:100%;max-width:960px;margin:0 auto;
      padding:1.8rem 1.25rem 3rem;
    }
    .logo-wrap{display:flex;justify-content:center;margin:0.5rem 0 0}
    .logo-wrap img{max-width:210px;height:auto}
    .page-title{
      text-align:center;margin-top:0.5rem;margin-bottom:0.25rem;
      font-size:2rem;letter-spacing:0.03em;
    }
    .page-subtitle{
      text-align:center;font-size:0.95rem;
      color:var(--text-muted);margin-bottom:2rem;
    }
    .panel{
      background:var(--bg-main);border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      padding:1.4rem 1.3rem 1.8rem;margin-bottom:1.3rem;
    }
    .panel-title{font-size:1.05rem;font-weight:600;margin-bottom:0.9rem}
    .panel-subtitle{font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem}
    .tool-grid{
      display:grid;
      grid-template-columns:minmax(0,1.45fr) minmax(0,1.1fr);
      gap:1.5rem;margin-top:0.5rem;
    }
    @media (max-width:880px){.tool-grid{grid-template-columns:minmax(0,1fr)}}
    .field-group{margin-bottom:1rem}
    .field-label{
      display:block;font-size:0.87rem;font-weight:500;margin-bottom:0.3rem;
    }
    .field-label span{font-weight:400;color:var(--text-muted);margin-left:0.2rem}
    .input,textarea{
      width:100%;border-radius:999px;border:1px solid var(--border-subtle);
      padding:0.6rem 0.9rem;font-size:0.95rem;outline:none;
      transition:border-color .15s,box-shadow .15s;background:#fff;
    }
    textarea{min-height:90px;border-radius:1rem;resize:vertical}
    .input:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,.15);
    }
    .input[disabled]{background:#f1f5f9;color:#9ca3af;cursor:not-allowed}
    .row-2{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:0.8rem;
    }
    @media (max-width:640px){.row-2{grid-template-columns:minmax(0,1fr)}}
    .checkbox-row{
      display:flex;align-items:center;gap:0.45rem;
      margin-top:0.15rem;margin-bottom:0.5rem;font-size:0.9rem;
    }
    .checkbox-row input[type="checkbox"]{width:17px;height:17px}
    .checkbox-row span{color:var(--text-main)}
    .buttons-row{
      display:flex;flex-wrap:wrap;gap:0.7rem;margin-top:0.9rem;
    }
    .btn{
      border-radius:var(--radius-full);border:1px solid transparent;
      padding:0.6rem 1.4rem;font-size:0.93rem;font-weight:600;
      letter-spacing:0.04em;text-transform:uppercase;
      cursor:pointer;transition:background .15s,color .15s,border-color .15s,transform .08s;
      white-space:nowrap;
    }
    .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-primary:active{transform:translateY(1px)}
    .btn-outline{background:#fff;color:var(--accent);border-color:var(--border-subtle)}
    .btn-outline.dashed{border-style:dashed}
    .btn-neutral{background:#fff;color:var(--text-muted);border-color:var(--border-subtle)}
    .btn:disabled{opacity:.42;cursor:not-allowed;transform:none}
    .results-grid{display:grid;grid-template-columns:minmax(0,1.2fr);gap:0.8rem}
    .results-row{display:flex;justify-content:space-between;font-size:0.95rem}
    .results-label{color:var(--text-main)}
    .results-value{font-weight:500;margin-left:0.6rem}
    .results-value.negative{color:var(--danger)}
    .results-value.positive{color:var(--positive)}
    .total-banner{
      margin-top:1.3rem;border-radius:1.2rem;
      background:linear-gradient(90deg,#059669,#22c55e);
      color:#fff;padding:0.75rem 1.1rem 0.9rem;
      display:flex;justify-content:space-between;align-items:center;
      font-weight:600;font-size:1rem;
    }
    .total-banner span:nth-child(2){font-size:1.15rem}
    .storico-panel{margin-top:0.3rem}
    .storico-list{
      margin-top:0.9rem;border-top:1px solid var(--border-subtle);
      padding-top:0.6rem;display:flex;flex-direction:column;gap:0.65rem;
      font-size:0.9rem;
    }
    .storico-item{
      display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;
      gap:0.5rem;padding:0.55rem 0.2rem;border-bottom:1px solid #e5e7eb;
    }
    .storico-main{display:flex;flex-direction:column;gap:0.1rem}
    .storico-title{font-weight:600;font-size:0.9rem}
    .storico-meta{font-size:0.8rem;color:var(--text-muted)}
    .storico-actions{display:flex;flex-wrap:wrap;gap:0.4rem}
    .storico-actions .btn{
      font-size:0.78rem;padding:0.35rem 0.9rem;
      text-transform:none;letter-spacing:0;
    }
    .btn-danger{
      border-color:rgba(185,28,28,.18);
      color:var(--danger);background:#fff;
    }
  </style>
</head>
<body>
  <div class="page">
    <main>
      <div class="container">
        <!-- LOGO + TITOLO -->
        <div class="logo-wrap">
          <!-- metti il path reale del logo -->
          <img src="/assets/logos/Logo EA Cleaning.png" alt="EA Cleaning – Cleaning Services" />
        </div>
        <h1 class="page-title">Area preventivi</h1>
        <p class="page-subtitle">
          Strumento interno EA Cleaning per calcolo, approvazione e archivio preventivi.
        </p>

        <div class="tool-grid">
          <!-- SINISTRA -->
          <section class="panel">
            <div class="panel-title">Dati cliente</div>

            <div class="row-2">
              <div class="field-group">
                <label class="field-label" for="numPreventivo">Numero preventivo</label>
                <input id="numPreventivo" class="input" type="text" readonly />
              </div>
              <div class="field-group">
                <label class="field-label" for="dataPreventivo">Data preventivo</label>
                <input id="dataPreventivo" class="input" type="date" />
              </div>
            </div>

            <div class="field-group">
              <label class="field-label" for="clienteNome">Ragione sociale / Cliente</label>
              <input id="clienteNome" class="input" type="text" />
            </div>

            <div class="field-group">
              <label class="field-label" for="clienteIndirizzo">Indirizzo</label>
              <input id="clienteIndirizzo" class="input" type="text" />
            </div>

            <div class="row-2">
              <div class="field-group">
                <label class="field-label" for="clienteTelefono">Telefono</label>
                <input id="clienteTelefono" class="input" type="text" />
              </div>
              <div class="field-group">
                <label class="field-label" for="clienteEmail">Email</label>
                <input id="clienteEmail" class="input" type="email" />
              </div>
            </div>

            <div class="field-group">
              <label class="field-label" for="oggettoPreventivo">Oggetto preventivo</label>
              <input id="oggettoPreventivo" class="input" type="text" />
            </div>

            <div class="field-group">
              <label class="field-label" for="descrizionePreventivo">Descrizione</label>
              <textarea id="descrizionePreventivo"></textarea>
            </div>

            <hr style="border:none;border-top:1px solid #e5e7eb;margin:1.2rem 0 1rem;" />

            <div class="panel-title">Parametri di lavoro</div>

            <div class="row-2">
              <div class="field-group">
                <label class="field-label" for="interventiSett">
                  Interventi settimanali <span>n° / settimana</span>
                </label>
                <input id="interventiSett" class="input" type="number" min="0" step="0.5" value="1" />
              </div>
              <div class="field-group">
                <label class="field-label" for="oreIntervento">
                  Ore per intervento <span>ore</span>
                </label>
                <input id="oreIntervento" class="input" type="number" min="0" step="0.25" value="1" />
              </div>
            </div>

            <div class="field-group">
              <div class="checkbox-row">
                <input id="flagProvvigione" type="checkbox" />
                <span>Provvigione agente / intermediario</span>
              </div>
              <div class="row-2">
                <input id="provvigionePerc" class="input" type="number" min="0" step="0.5" value="0" disabled />
                <div style="display:flex;align-items:center;font-size:0.9rem;color:var(--text-muted);">
                  % sul prezzo finale
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="checkbox-row">
                <input id="flagSubappalto" type="checkbox" />
                <span>Subappalto (costo 16 €/h, prezzo 26 €/h)</span>
              </div>
            </div>

            <div class="field-group">
              <div class="checkbox-row">
                <input id="flagCostoInterno" type="checkbox" checked />
                <span>Costo orario interno</span>
              </div>
              <div class="row-2">
                <input id="costoOrarioInterno" class="input" type="number" min="0" step="0.5" value="23" />
                <div style="display:flex;align-items:center;font-size:0.9rem;color:var(--text-muted);">
                  €/h (ricavo minimo orario)
                </div>
              </div>
            </div>

            <div class="field-group">
              <label class="field-label">
                Costo prodotti <span>10% automatico sul costo lavoro</span>
              </label>
            </div>

            <div class="field-group">
              <div class="checkbox-row">
                <input id="flagAttrezzature" type="checkbox" />
                <span>Attrezzature / noleggi</span>
              </div>
              <div class="row-2">
                <input id="costoAttrezzature" class="input" type="number" min="0" step="1" value="0" disabled />
                <div style="display:flex;align-items:center;font-size:0.9rem;color:var(--text-muted);">
                  €/mese
                </div>
              </div>
            </div>

            <div class="buttons-row">
              <button id="btnCalcola" class="btn btn-primary">Calcola preventivo</button>
              <button id="btnPdfInterno" class="btn btn-outline" disabled>Esporta PDF (interno)</button>
              <button id="btnPdfCliente" class="btn btn-outline" disabled>PDF cliente</button>
            </div>

            <div class="buttons-row">
              <button id="btnApprova" class="btn btn-outline dashed" disabled>
                Approva (salva storico)
              </button>
              <button id="btnReset" class="btn btn-neutral">Reset</button>
            </div>
          </section>

          <!-- DESTRA -->
          <section class="panel">
            <div class="panel-title">Riepilogo economico mensile</div>

            <div class="results-grid">
              <div class="results-row">
                <span class="results-label">Ore totali mese</span>
                <span id="oreMese" class="results-value">0,00 h</span>
              </div>
              <div class="results-row">
                <span class="results-label">Costo lavoro</span>
                <span id="costoLavoro" class="results-value negative">0,00 €</span>
              </div>
              <div class="results-row">
                <span class="results-label">Costo prodotti (10%)</span>
                <span id="costoProdotti" class="results-value negative">0,00 €</span>
              </div>
              <div class="results-row">
                <span class="results-label">Costo attrezzature</span>
                <span id="costoAttrezzatureRes" class="results-value negative">0,00 €</span>
              </div>
              <div class="results-row">
                <span class="results-label">Provvigione</span>
                <span id="costoProvvigione" class="results-value negative">0,00 €</span>
              </div>
              <div class="results-row">
                <span class="results-label">Costo totale aziendale</span>
                <span id="costoTotale" class="results-value negative">0,00 €</span>
              </div>

              <div class="results-row">
                <span class="results-label">Tariffa oraria (netta)</span>
                <span id="prezzoOrarioRes" class="results-value positive">0,00 €/h</span>
              </div>
              <div class="results-row">
                <span class="results-label">Ricavo lavoro (solo ore)</span>
                <span id="ricavoLavoro" class="results-value positive">0,00 €</span>
              </div>
              <div class="results-row">
                <span class="results-label">Guadagno netto</span>
                <span id="guadagnoNetto" class="results-value positive">0,00 €</span>
              </div>
              <div class="results-row">
                <span class="results-label">Guadagno netto %</span>
                <span id="guadagnoPerc" class="results-value positive">0,0 %</span>
              </div>
            </div>

            <div class="total-banner">
              <span>Totale mensile da proporre al cliente</span>
              <span id="prezzoTotaleCliente">0,00 €</span>
            </div>
          </section>
        </div>

        <!-- STORICO -->
        <section class="panel storico-panel">
          <div class="panel-title">Preventivi storici (solo su questo dispositivo)</div>
          <p class="panel-subtitle">
            Ogni preventivo approvato viene salvato localmente. Puoi riaprirlo, ristampare i PDF o eliminarlo.
          </p>
          <div id="storicoList" class="storico-list">
            <p style="font-size:0.85rem;color:var(--text-muted);">
              Nessun preventivo salvato. Dopo averlo calcolato, usa “Approva (salva storico)”.
            </p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    const COSTO_REALE_INTERNO = 16; // €/h costo reale dipendente

    // ---- DOM ----
    const numPreventivoInput = document.getElementById("numPreventivo");
    const dataPreventivoInput = document.getElementById("dataPreventivo");
    const clienteNomeInput = document.getElementById("clienteNome");
    const clienteIndirizzoInput = document.getElementById("clienteIndirizzo");
    const clienteTelefonoInput = document.getElementById("clienteTelefono");
    const clienteEmailInput = document.getElementById("clienteEmail");
    const oggettoPreventivoInput = document.getElementById("oggettoPreventivo");
    const descrizionePreventivoInput = document.getElementById("descrizionePreventivo");

    const interventiSettInput = document.getElementById("interventiSett");
    const oreInterventoInput = document.getElementById("oreIntervento");
    const flagProvvigione = document.getElementById("flagProvvigione");
    const provvigionePercInput = document.getElementById("provvigionePerc");
    const flagSubappalto = document.getElementById("flagSubappalto");
    const flagCostoInterno = document.getElementById("flagCostoInterno");
    const costoOrarioInternoInput = document.getElementById("costoOrarioInterno");
    const flagAttrezzature = document.getElementById("flagAttrezzature");
    const costoAttrezzatureInput = document.getElementById("costoAttrezzature");

    const oreMeseSpan = document.getElementById("oreMese");
    const costoLavoroSpan = document.getElementById("costoLavoro");
    const costoProdottiSpan = document.getElementById("costoProdotti");
    const costoAttrezzatureResSpan = document.getElementById("costoAttrezzatureRes");
    const costoProvvigioneSpan = document.getElementById("costoProvvigione");
    const costoTotaleSpan = document.getElementById("costoTotale");
    const prezzoOrarioResSpan = document.getElementById("prezzoOrarioRes");
    const ricavoLavoroSpan = document.getElementById("ricavoLavoro");
    const guadagnoNettoSpan = document.getElementById("guadagnoNetto");
    const guadagnoPercSpan = document.getElementById("guadagnoPerc");
    const prezzoTotaleClienteSpan = document.getElementById("prezzoTotaleCliente");

    const btnCalcola = document.getElementById("btnCalcola");
    const btnPdfInterno = document.getElementById("btnPdfInterno");
    const btnPdfCliente = document.getElementById("btnPdfCliente");
    const btnApprova = document.getElementById("btnApprova");
    const btnReset = document.getElementById("btnReset");
    const storicoListEl = document.getElementById("storicoList");

    const STORAGE_KEY = "eaPreventiviStorico";
    const STORAGE_NEXT_NUM = "eaPreventivoNextNumero";

    let ultimoPreventivo = null;

    // ---- utility ----
    function parseNum(el, def) {
      const v = typeof el === "number" ? el : parseFloat(String(el.value).replace(",", "."));
      return isNaN(v) ? def : v;
    }
    function formatEuro(v) {
      return (v || 0).toFixed(2).replace(".", ",") + " €";
    }
    function formatOre(v) {
      return (v || 0).toFixed(2).replace(".", ",") + " h";
    }
    function formatPerc(v) {
      return (v || 0).toFixed(1).replace(".", ",") + " %";
    }
    function todayISO() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return d.getFullYear() + "-" + m + "-" + day;
    }

    function initNumeroPreventivo() {
      const year = new Date().getFullYear();
      let next = parseInt(localStorage.getItem(STORAGE_NEXT_NUM) || "1", 10);
      if (isNaN(next) || next < 1) next = 1;
      numPreventivoInput.value = year + "-" + String(next).padStart(3, "0");
    }
    function incrementNumeroPreventivo() {
      let next = parseInt(localStorage.getItem(STORAGE_NEXT_NUM) || "1", 10);
      if (isNaN(next) || next < 1) next = 1;
      next++;
      localStorage.setItem(STORAGE_NEXT_NUM, String(next));
      initNumeroPreventivo();
    }
    function setButtonsEnabled(on) {
      btnPdfInterno.disabled = !on;
      btnPdfCliente.disabled = !on;
      btnApprova.disabled = !on;
    }
    function resetRiepilogo() {
      oreMeseSpan.textContent = formatOre(0);
      costoLavoroSpan.textContent = formatEuro(0);
      costoProdottiSpan.textContent = formatEuro(0);
      costoAttrezzatureResSpan.textContent = formatEuro(0);
      costoProvvigioneSpan.textContent = formatEuro(0);
      costoTotaleSpan.textContent = formatEuro(0);
      prezzoOrarioResSpan.textContent = "0,00 €/h";
      ricavoLavoroSpan.textContent = formatEuro(0);
      guadagnoNettoSpan.textContent = formatEuro(0);
      guadagnoPercSpan.textContent = formatPerc(0);
      prezzoTotaleClienteSpan.textContent = formatEuro(0);
    }
    function loadStorico() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }
    function saveStorico(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }
    function renderStorico() {
      const lista = loadStorico();
      if (!lista.length) {
        storicoListEl.innerHTML =
          '<p style="font-size:0.85rem;color:var(--text-muted);">Nessun preventivo salvato. Dopo averlo calcolato, usa “Approva (salva storico)”.</p>';
        return;
      }
      let html = "";
      lista.forEach((p, idx) => {
        html += `
        <div class="storico-item" data-index="${idx}">
          <div class="storico-main">
            <div class="storico-title">${p.numero} – ${p.cliente || "Cliente"}</div>
            <div class="storico-meta">
              Data: ${p.data || "-"} • Totale: ${p.risultati ? p.risultati.prezzoTotaleCliente : "-"}
            </div>
          </div>
          <div class="storico-actions">
            <button class="btn btn-outline btn-open" data-index="${idx}">Apri</button>
            <button class="btn btn-outline btn-pdf-int" data-index="${idx}">PDF interno</button>
            <button class="btn btn-outline btn-pdf-cli" data-index="${idx}">PDF cliente</button>
            <button class="btn btn-danger btn-del" data-index="${idx}">Elimina</button>
          </div>
        </div>`;
      });
      storicoListEl.innerHTML = html;

      storicoListEl.querySelectorAll(".btn-open").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.index, 10);
          const p = loadStorico()[idx];
          if (p) caricaPreventivoInForm(p);
        });
      });
      storicoListEl.querySelectorAll(".btn-pdf-int").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.index, 10);
          const p = loadStorico()[idx];
          if (p) generaPdfInterno(p);
        });
      });
      storicoListEl.querySelectorAll(".btn-pdf-cli").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.index, 10);
          const p = loadStorico()[idx];
          if (p) generaPdfCliente(p);
        });
      });
      storicoListEl.querySelectorAll(".btn-del").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.index, 10);
          const listaNow = loadStorico();
          listaNow.splice(idx, 1);
          saveStorico(listaNow);
          renderStorico();
        });
      });
    }

    function caricaPreventivoInForm(p) {
      numPreventivoInput.value = p.numero || "";
      dataPreventivoInput.value = p.data || todayISO();
      clienteNomeInput.value = p.cliente || "";
      clienteIndirizzoInput.value = p.indirizzo || "";
      clienteTelefonoInput.value = p.telefono || "";
      clienteEmailInput.value = p.email || "";
      oggettoPreventivoInput.value = p.oggetto || "";
      descrizionePreventivoInput.value = p.descrizione || "";

      if (p.parametri) {
        interventiSettInput.value = p.parametri.interventi ?? 0;
        oreInterventoInput.value = p.parametri.oreIntervento ?? 0;
        flagProvvigione.checked = !!p.parametri.provvigioneAttiva;
        provvigionePercInput.disabled = !flagProvvigione.checked;
        provvigionePercInput.value = p.parametri.provvigionePerc ?? 0;
        flagSubappalto.checked = !!p.parametri.subappalto;
        flagCostoInterno.checked = !!p.parametri.costoInternoAttivo;
        costoOrarioInternoInput.disabled = !flagCostoInterno.checked;
        costoOrarioInternoInput.value = p.parametri.prezzoOrarioTarget ?? 23;
        flagAttrezzature.checked = !!p.parametri.attrezzatureAttive;
        costoAttrezzatureInput.disabled = !flagAttrezzature.checked;
        costoAttrezzatureInput.value = p.parametri.costoAttrezzature ?? 0;
      }

      if (p.risultati) {
        oreMeseSpan.textContent = p.risultati.oreMese;
        costoLavoroSpan.textContent = p.risultati.costoLavoro;
        costoProdottiSpan.textContent = p.risultati.costoProdotti;
        costoAttrezzatureResSpan.textContent = p.risultati.costoAttrezzature;
        costoProvvigioneSpan.textContent = p.risultati.costoProvvigione;
        costoTotaleSpan.textContent = p.risultati.costoTotale;
        prezzoOrarioResSpan.textContent = p.risultati.prezzoOrario;
        ricavoLavoroSpan.textContent = p.risultati.ricavoLavoro;
        guadagnoNettoSpan.textContent = p.risultati.guadagnoNetto;
        guadagnoPercSpan.textContent = p.risultati.guadagnoPerc;
        prezzoTotaleClienteSpan.textContent = p.risultati.prezzoTotaleCliente;
      }

      ultimoPreventivo = p;
      setButtonsEnabled(true);
    }

    // ---- CALCOLO CON PROVVIGIONE CORRETTA ----
    function calcolaPreventivo() {
      const interventi = parseNum(interventiSettInput, 0);
      const oreIntervento = parseNum(oreInterventoInput, 0);
      const oreMese = interventi * oreIntervento * 4.33;

      if (oreMese <= 0) {
        resetRiepilogo();
        setButtonsEnabled(false);
        ultimoPreventivo = null;
        return;
      }

      const hasProvv = flagProvvigione.checked;
      const provvPerc = hasProvv ? parseNum(provvigionePercInput, 0) : 0;
      const a = hasProvv ? provvPerc / 100 : 0;

      const hasSub = flagSubappalto.checked;
      const hasCostoInterno = flagCostoInterno.checked;
      const hasAttrezz = flagAttrezzature.checked;

      const tariffaTarget = hasSub
        ? 26
        : (hasCostoInterno ? parseNum(costoOrarioInternoInput, 23) : 23);

      const costoAttrezzature = hasAttrezz ? parseNum(costoAttrezzatureInput, 0) : 0;

      const costoLavoroOrario = hasSub ? 16 : COSTO_REALE_INTERNO;
      const costoLavoro = oreMese * costoLavoroOrario;

      const costoProdotti = costoLavoro * 0.10;
      const extraFissi = costoProdotti + costoAttrezzature;

      let prezzoTotaleCliente;
      if (a >= 1) {
        prezzoTotaleCliente = tariffaTarget * oreMese + extraFissi;
      } else {
        // (P - provv - extraFissi)/oreMese = tariffaTarget  ->  P = (tariffaTarget*oreMese + extraFissi)/(1-a)
        prezzoTotaleCliente = (tariffaTarget * oreMese + extraFissi) / (1 - a);
      }

      const costoProvvigione = prezzoTotaleCliente * a;
      const costoTotaleAziendale = costoLavoro + costoProdotti + costoAttrezzature + costoProvvigione;

      const ricavoOre = tariffaTarget * oreMese;             // ciò che rimane tolti provvigione+prodotti+attrezzature
      const guadagnoNetto = ricavoOre - costoLavoro;         // margine dopo aver pagato il lavoro
      const guadagnoPerc = prezzoTotaleCliente > 0
        ? (guadagnoNetto / prezzoTotaleCliente) * 100
        : 0;

      // UI
      oreMeseSpan.textContent = formatOre(oreMese);
      costoLavoroSpan.textContent = formatEuro(costoLavoro);
      costoProdottiSpan.textContent = formatEuro(costoProdotti);
      costoAttrezzatureResSpan.textContent = formatEuro(costoAttrezzature);
      costoProvvigioneSpan.textContent = formatEuro(costoProvvigione);
      costoTotaleSpan.textContent = formatEuro(costoTotaleAziendale);
      prezzoOrarioResSpan.textContent =
        tariffaTarget.toFixed(2).replace(".", ",") + " €/h";  // 23 o 26 netti
      ricavoLavoroSpan.textContent = formatEuro(ricavoOre);
      guadagnoNettoSpan.textContent = formatEuro(guadagnoNetto);
      guadagnoPercSpan.textContent = formatPerc(guadagnoPerc);
      prezzoTotaleClienteSpan.textContent = formatEuro(prezzoTotaleCliente);

      setButtonsEnabled(true);

      ultimoPreventivo = {
        numero: numPreventivoInput.value.trim(),
        data: dataPreventivoInput.value,
        cliente: clienteNomeInput.value.trim(),
        indirizzo: clienteIndirizzoInput.value.trim(),
        telefono: clienteTelefonoInput.value.trim(),
        email: clienteEmailInput.value.trim(),
        oggetto: oggettoPreventivoInput.value.trim(),
        descrizione: descrizionePreventivoInput.value.trim(),
        parametri: {
          interventi,
          oreIntervento,
          provvigioneAttiva: hasProvv,
          provvigionePerc: provvPerc,
          subappalto: hasSub,
          costoInternoAttivo: hasCostoInterno,
          prezzoOrarioTarget: tariffaTarget,
          costoLavoroOrario,
          attrezzatureAttive: hasAttrezz,
          costoAttrezzature
        },
        risultati: {
          oreMese: formatOre(oreMese),
          costoLavoro: formatEuro(costoLavoro),
          costoProdotti: formatEuro(costoProdotti),
          costoAttrezzature: formatEuro(costoAttrezzature),
          costoProvvigione: formatEuro(costoProvvigione),
          costoTotale: formatEuro(costoTotaleAziendale),
          prezzoOrario: tariffaTarget.toFixed(2).replace(".", ",") + " €/h",
          ricavoLavoro: formatEuro(ricavoOre),
          guadagnoNetto: formatEuro(guadagnoNetto),
          guadagnoPerc: formatPerc(guadagnoPerc),
          prezzoTotaleCliente: formatEuro(prezzoTotaleCliente)
        }
      };
    }

    // ---- PDF interno ----
    function generaPdfInterno(p) {
      if (!p || !p.risultati) return;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("EA Cleaning – Preventivo interno", 14, 18);
      doc.setFontSize(11);
      doc.text("Nr: " + (p.numero || ""), 14, 26);
      doc.text("Data: " + (p.data || ""), 196, 26, { align: "right" });
      doc.text("Cliente: " + (p.cliente || "-"), 14, 34);
      if (p.oggetto) doc.text("Oggetto: " + p.oggetto, 14, 42);

      let y = 58;
      doc.text("Riepilogo economico mensile", 14, y);
      y += 6;
      const row = (label, value, color) => {
        doc.setTextColor(0,0,0);
        doc.text(label, 14, y);
        if (color==="red") doc.setTextColor(180,20,20);
        if (color==="green") doc.setTextColor(20,130,60);
        doc.text(value, 196, y, { align:"right" });
        y += 6;
      };
      row("Ore totali mese", p.risultati.oreMese, null);
      row("Costo lavoro", p.risultati.costoLavoro, "red");
      row("Costo prodotti (10%)", p.risultati.costoProdotti, "red");
      row("Costo attrezzature", p.risultati.costoAttrezzature, "red");
      row("Provvigione", p.risultati.costoProvvigione, "red");
      row("Costo totale aziendale", p.risultati.costoTotale, "red");
      row("Tariffa oraria (netta)", p.risultati.prezzoOrario, "green");
      row("Ricavo lavoro (solo ore)", p.risultati.ricavoLavoro, "green");
      row("Guadagno netto", p.risultati.guadagnoNetto, "green");
      row("Guadagno netto %", p.risultati.guadagnoPerc, "green");

      y += 4;
      doc.setFillColor(5,150,80);
      doc.setTextColor(255,255,255);
      doc.roundedRect(14, y, 182, 10, 2, 2, "F");
      doc.text("Totale mensile da proporre al cliente", 18, y+7);
      doc.text(p.risultati.prezzoTotaleCliente, 192, y+7, { align:"right" });

      doc.save((p.numero || "preventivo") + "_interno.pdf");
    }

    // ---- PDF cliente ----
    function generaPdfCliente(p) {
      if (!p || !p.risultati) return;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("EA Cleaning – Preventivo servizi di pulizia", 14, 18);
      doc.setFontSize(11);
      doc.text("Nr: " + (p.numero || ""), 14, 26);
      doc.text("Data: " + (p.data || ""), 196, 26, { align:"right" });

      doc.text("Spett.le", 14, 38);
      doc.text(p.cliente || "-", 14, 44);
      if (p.indirizzo) doc.text(p.indirizzo, 14, 50);

      let y = 64;
      doc.text("Proposta economica", 14, y);
      y += 4;

      doc.setDrawColor(0,0,0);
      doc.rect(14, y, 182, 8);
      doc.text("Totale mensile servizi di pulizia", 16, y+5);
      doc.rect(14, y+8, 182, 10);
      doc.text(p.risultati.prezzoTotaleCliente, 194, y+15, { align:"right" });

      const fy = 105;
      doc.setFontSize(9);
      doc.setTextColor(120,120,120);
      doc.text(
        "Il presente preventivo è valido 30 giorni dalla data di emissione salvo diverse indicazioni.",
        14, fy
      );
      doc.text(
        "Restiamo a disposizione per eventuali chiarimenti e per un sopralluogo dettagliato.",
        14, fy+5
      );

      doc.save((p.numero || "preventivo") + "_cliente.pdf");
    }

    // ---- EVENTI ----
    flagProvvigione.addEventListener("change", () => {
      provvigionePercInput.disabled = !flagProvvigione.checked;
      if (!flagProvvigione.checked) provvigionePercInput.value = "0";
    });
    flagAttrezzature.addEventListener("change", () => {
      costoAttrezzatureInput.disabled = !flagAttrezzature.checked;
      if (!flagAttrezzature.checked) costoAttrezzatureInput.value = "0";
    });
    flagCostoInterno.addEventListener("change", () => {
      costoOrarioInternoInput.disabled = !flagCostoInterno.checked;
    });

    btnCalcola.addEventListener("click", e => {
      e.preventDefault();
      calcolaPreventivo();
    });
    btnPdfInterno.addEventListener("click", e => {
      e.preventDefault();
      if (ultimoPreventivo) generaPdfInterno(ultimoPreventivo);
    });
    btnPdfCliente.addEventListener("click", e => {
      e.preventDefault();
      if (ultimoPreventivo) generaPdfCliente(ultimoPreventivo);
    });
    btnApprova.addEventListener("click", e => {
      e.preventDefault();
      if (!ultimoPreventivo || !ultimoPreventivo.risultati) return;
      const lista = loadStorico();
      lista.push({ ...ultimoPreventivo, id: Date.now() });
      saveStorico(lista);
      renderStorico();
      incrementNumeroPreventivo();
    });
    btnReset.addEventListener("click", e => {
      e.preventDefault();
      clienteNomeInput.value = "";
      clienteIndirizzoInput.value = "";
      clienteTelefonoInput.value = "";
      clienteEmailInput.value = "";
      oggettoPreventivoInput.value = "";
      descrizionePreventivoInput.value = "";
      interventiSettInput.value = "1";
      oreInterventoInput.value = "1";
      flagProvvigione.checked = false;
      provvigionePercInput.disabled = true;
      provvigionePercInput.value = "0";
      flagSubappalto.checked = false;
      flagCostoInterno.checked = true;
      costoOrarioInternoInput.disabled = false;
      costoOrarioInternoInput.value = "23";
      flagAttrezzature.checked = false;
      costoAttrezzatureInput.disabled = true;
      costoAttrezzatureInput.value = "0";
      resetRiepilogo();
      setButtonsEnabled(false);
      ultimoPreventivo = null;
    });

    // ---- INIT ----
    (function init(){
      dataPreventivoInput.value = todayISO();
      initNumeroPreventivo();
      renderStorico();
      resetRiepilogo();
      setButtonsEnabled(false);
    })();
  </script>
</body>
</html>
